<html lang="en">

<head>
    <meta charset="utf-8">
    <title>PANAS-GEN Windrose + History</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        :root {
            --pad: 18px
        }

        body {
            font-family: system-ui, Arial, sans-serif;
            margin: 0;
            padding: var(--pad);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--pad)
        }

        h2 {
            margin: .2rem 0 .6rem
        }

        #left,
        #right {
            min-width: 320px
        }

        svg {
            width: 100%;
            height: 620px
        }

        svg#timeseries {
            height: 310px
        }

        .grid circle {
            fill: none;
            stroke: #eee
        }

        .axis line {
            stroke: #ccc
        }

        .label {
            font-size: 11px;
            text-anchor: middle
        }

        .handle {
            fill: #1f77b4;
            cursor: pointer
        }

        .current {
            fill: rgba(31, 119, 180, .25);
            stroke: #1f77b4;
            stroke-width: 2
        }

        .reference {
            fill: none;
            stroke: #888;
            stroke-width: 2;
            stroke-dasharray: 6, 6
        }

        .preview {
            fill: rgba(128, 0, 128, .12);
            stroke: purple;
            stroke-width: 2;
            stroke-dasharray: 4, 6
        }

        .monthly {
            fill: rgba(0, 128, 0, .10);
            stroke: green;
            stroke-width: 2;
            stroke-dasharray: 6, 4
        }

        .controls {
            display: flex;
            gap: .5rem;
            flex-wrap: wrap;
            margin-top: .5rem
        }

        button {
            padding: .5rem .8rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fff;
            cursor: pointer
        }

        button:hover {
            background: #f5f5f5
        }

        #status {
            font-size: .9rem;
            color: #666;
            margin-top: .4rem
        }

        .legend {
            display: flex;
            gap: 12px;
            align-items: center;
            margin: .3rem 0 .8rem
        }

        .sw {
            display: inline-block;
            width: 16px;
            height: 10px;
            border-radius: 2px
        }

        .sw.pos {
            background: #ffdc28
        }

        .sw.neg {
            background: #7832a0
        }

        .sw.extraversion {
            background: #ff7f0e
        }

        .sw.agreeableness {
            background: #2ca02c
        }

        .sw.conscientiousness {
            background: #9467bd
        }

        .sw.neuroticism {
            background: #8c564b
        }

        .sw.openness {
            background: #e377c2
        }

        textarea {
            width: 100%;
            height: 80px;
            margin-top: .6rem;
            padding: .4rem;
            font-family: inherit;
            font-size: 14px
        }

        .tooltip {
            position: absolute;
            pointer-events: none;
            background: rgba(0, 0, 0, .75);
            color: #fff;
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            max-width: 360px;
            line-height: 1.35
        }

        .import-box {
            margin: .6rem 0;
            padding: 14px;
            border: 2px dashed #bbb;
            border-radius: 10px;
            text-align: center;
            font-size: .95rem;
            color: #555;
            user-select: none;
            cursor: pointer
        }

        .import-box strong {
            display: block;
            margin-bottom: .25rem
        }

        .import-box.hover {
            background: #fafafa;
            border-color: #888
        }

        .import-help {
            font-size: .85rem;
            color: #777;
            margin-top: .25rem
        }

        .row {
            display: grid;
            grid-template-columns: 1fr;
            gap: .6rem
        }

        .settings-toggle {
            margin-bottom: .5rem;
        }

        .settings-toggle button {
            font-size: 12px;
            padding: .4rem .6rem;
        }

        .settings-box {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            background: #f9f9f9;
            margin-bottom: 1rem;
            display: none;
        }

        .settings-box.expanded {
            display: block;
        }

        .settings-box input {
            width: 100%;
            padding: .5rem;
            margin-top: .3rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }

        .settings-box label {
            display: block;
            margin-top: .8rem;
            font-weight: 600;
            font-size: 13px;
        }

        .settings-box button {
            margin-top: .8rem;
        }

        .sync-status {
            margin-top: .5rem;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>

<body>
    <div id="left">
        <h2>PANAS-GEN Windrose (drag petals)</h2>

        <div class="row">
            <div class="settings-toggle">
                <button id="toggleSettings">⚙️ GitHub Sync Settings</button>
            </div>
            <div class="settings-box" id="settingsBox">
                <strong>GitHub Sync Settings</strong>
                <label>GitHub Token (with repo permissions):</label>
                <input id="ghToken" type="password" placeholder="ghp_...">
                <label>Owner:</label>
                <input id="ghOwner" type="text" placeholder="rlhjansen">
                <label>Repo:</label>
                <input id="ghRepo" type="text" placeholder="minimal_mood_dashboard">
                <label>Branch:</label>
                <input id="ghBranch" type="text" placeholder="main">
                <label>Data file path:</label>
                <input id="ghPath" type="text" placeholder="data/entries.json">
                <button id="saveSettings">Save Settings</button>
                <button id="testSync">Test Sync Now</button>
                <div class="sync-status" id="syncStatus"></div>
            </div>
        </div>

        <div class="row">
            <div id="importBox" class="import-box" tabindex="0">
                <strong>Import database (.sqlite)</strong>
                Drop file here or click to choose
                <div class="import-help">Replaces the in-browser database; UI refreshes from the newest entry.</div>
                <input id="fileInput" type="file" accept=".sqlite,application/x-sqlite3,application/octet-stream"
                    style="display:none">
            </div>
        </div>

        <svg id="radar" viewBox="0,0,620,620">
            <g transform="translate(310,310)">
                <circle r="48" class="grid"></circle>
                <circle r="96" class="grid"></circle>
                <circle r="144" class="grid"></circle>
                <circle r="192" class="grid"></circle>
                <circle r="240" class="grid"></circle>
                <line class="axis" x1="0" y1="0" x2="240" y2="0"></line><text class="label" x="260" y="0">Nervous</text>
                <line class="axis" x1="0" y1="0" x2="228.25356391083685" y2="74.16407864998737"></line><text
                    class="label" x="247.27469423673992" y="80.34441853748632">Irritable</text>
                <line class="axis" x1="0" y1="0" x2="194.1640786499874" y2="141.06846055019355"></line><text
                    class="label" x="210.34441853748635" y="152.824165596043">Interested</text>
                <line class="axis" x1="0" y1="0" x2="141.06846055019355" y2="194.1640786499874"></line><text
                    class="label" x="152.824165596043" y="210.34441853748635">Strong</text>
                <line class="axis" x1="0" y1="0" x2="74.16407864998739" y2="228.25356391083685"></line><text
                    class="label" x="80.34441853748633" y="247.27469423673992">Upset</text>
                <line class="axis" x1="0" y1="0" x2="1.469576158976824e-14" y2="240"></line><text class="label"
                    x="1.592040838891559e-14" y="260">Enthusiastic</text>
                <line class="axis" x1="0" y1="0" x2="-74.16407864998736" y2="228.25356391083687"></line><text
                    class="label" x="-80.3444185374863" y="247.27469423673995">Attentive</text>
                <line class="axis" x1="0" y1="0" x2="-141.06846055019352" y2="194.1640786499874"></line><text
                    class="label" x="-152.82416559604297" y="210.34441853748635">Determined</text>
                <line class="axis" x1="0" y1="0" x2="-194.16407864998737" y2="141.06846055019358"></line><text
                    class="label" x="-210.34441853748632" y="152.82416559604303">Excited</text>
                <line class="axis" x1="0" y1="0" x2="-228.25356391083685" y2="74.1640786499874"></line><text
                    class="label" x="-247.27469423673992" y="80.34441853748635">Jittery</text>
                <line class="axis" x1="0" y1="0" x2="-240" y2="2.939152317953648e-14"></line><text class="label"
                    x="-260" y="3.184081677783118e-14">Guilty</text>
                <line class="axis" x1="0" y1="0" x2="-228.25356391083685" y2="-74.16407864998746"></line><text
                    class="label" x="-247.27469423673992" y="-80.3444185374864">Alert</text>
                <line class="axis" x1="0" y1="0" x2="-194.1640786499874" y2="-141.06846055019352"></line><text
                    class="label" x="-210.34441853748638" y="-152.82416559604297">Afraid</text>
                <line class="axis" x1="0" y1="0" x2="-141.06846055019358" y2="-194.16407864998737"></line><text
                    class="label" x="-152.82416559604303" y="-210.34441853748632">Active</text>
                <line class="axis" x1="0" y1="0" x2="-74.16407864998742" y2="-228.25356391083685"></line><text
                    class="label" x="-80.34441853748636" y="-247.27469423673992">Distressed</text>
                <line class="axis" x1="0" y1="0" x2="-4.408728476930471e-14" y2="-240"></line><text class="label"
                    x="-4.776122516674677e-14" y="-260">Hostile</text>
                <line class="axis" x1="0" y1="0" x2="74.16407864998733" y2="-228.25356391083687"></line><text
                    class="label" x="80.34441853748628" y="-247.27469423673995">Inspired</text>
                <line class="axis" x1="0" y1="0" x2="141.0684605501935" y2="-194.1640786499874"></line><text
                    class="label" x="152.82416559604295" y="-210.34441853748638">Ashamed</text>
                <line class="axis" x1="0" y1="0" x2="194.16407864998737" y2="-141.0684605501936"></line><text
                    class="label" x="210.34441853748632" y="-152.8241655960431">Scared</text>
                <line class="axis" x1="0" y1="0" x2="228.25356391083685" y2="-74.16407864998745"></line><text
                    class="label" x="247.27469423673992" y="-80.34441853748639">Proud</text>
                <path class="reference"
                    d="M96,0L45.651,14.833L38.833,28.214L28.214,38.833L14.833,45.651L0,48L-29.666,91.301L-28.214,38.833L-38.833,28.214L-45.651,14.833L-96,0L-45.651,-14.833L-77.666,-56.427L-28.214,-38.833L-29.666,-91.301L0,-48L14.833,-45.651L28.214,-38.833L38.833,-28.214L45.651,-14.833Z">
                </path>
                <path class="current"
                    d="M96,0L45.651,14.833L38.833,28.214L28.214,38.833L14.833,45.651L0,48L-29.666,91.301L-28.214,38.833L-38.833,28.214L-45.651,14.833L-96,0L-45.651,-14.833L-77.666,-56.427L-28.214,-38.833L-29.666,-91.301L0,-48L14.833,-45.651L28.214,-38.833L38.833,-28.214L45.651,-14.833Z">
                </path>
                <path class="preview"></path>
                <path class="monthly"
                    d="M144,0L45.651,14.833L51.777,37.618L47.023,64.721L29.666,91.301L0,64L-29.666,91.301L-65.832,90.61L-51.777,37.618L-76.085,24.721L-112,0L-76.085,-24.721L-90.61,-65.832L-47.023,-64.721L-34.61,-106.518L0,-64L19.777,-60.868L65.832,-90.61L51.777,-37.618L60.868,-19.777Z">
                </path>
                <g>
                    <circle class="handle" r="6" cx="96" cy="0"
                        style="touch-action: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></circle>
                    <circle class="handle" r="6" cx="45.65071278216737" cy="14.832815729997474"
                        style="touch-action: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></circle>
                    <circle class="handle" r="6" cx="38.83281572999748" cy="28.21369211003871"
                        style="touch-action: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></circle>
                    <circle class="handle" r="6" cx="28.21369211003871" cy="38.83281572999748"
                        style="touch-action: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></circle>
                    <circle class="handle" r="6" cx="14.832815729997478" cy="45.65071278216737"
                        style="touch-action: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></circle>
                    <circle class="handle" r="6" cx="2.9391523179536475e-15" cy="48"
                        style="touch-action: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></circle>
                    <circle class="handle" r="6" cx="-29.665631459994945" cy="91.30142556433475"
                        style="touch-action: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></circle>
                    <circle class="handle" r="6" cx="-28.213692110038707" cy="38.83281572999748"
                        style="touch-action: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></circle>
                    <circle class="handle" r="6" cx="-38.83281572999747" cy="28.213692110038714"
                        style="touch-action: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></circle>
                    <circle class="handle" r="6" cx="-45.65071278216737" cy="14.832815729997481"
                        style="touch-action: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></circle>
                    <circle class="handle" r="6" cx="-96" cy="1.175660927181459e-14"
                        style="touch-action: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></circle>
                    <circle class="handle" r="6" cx="-45.65071278216737" cy="-14.832815729997492"
                        style="touch-action: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></circle>
                    <circle class="handle" r="6" cx="-77.66563145999497" cy="-56.427384220077414"
                        style="touch-action: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></circle>
                    <circle class="handle" r="6" cx="-28.213692110038714" cy="-38.83281572999747"
                        style="touch-action: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></circle>
                    <circle class="handle" r="6" cx="-29.665631459994966" cy="-91.30142556433474"
                        style="touch-action: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></circle>
                    <circle class="handle" r="6" cx="-8.817456953860943e-15" cy="-48"
                        style="touch-action: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></circle>
                    <circle class="handle" r="6" cx="14.832815729997467" cy="-45.650712782167375"
                        style="touch-action: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></circle>
                    <circle class="handle" r="6" cx="28.2136921100387" cy="-38.832815729997485"
                        style="touch-action: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></circle>
                    <circle class="handle" r="6" cx="38.83281572999747" cy="-28.21369211003872"
                        style="touch-action: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></circle>
                    <circle class="handle" r="6" cx="45.65071278216737" cy="-14.832815729997488"
                        style="touch-action: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></circle>
                </g>
            </g>
        </svg>
        <label for="log">Log:</label>
        <textarea id="log" placeholder="Log..."></textarea>

        <div class="controls">
            <button id="randomize">Randomize petals</button>
            <button id="save">Save + Download DB + Page</button>
            <button id="copyJson">Copy JSON</button>
            <button id="clear">Clear DB</button>
        </div>

        <div id="status">30-day average (3 entries)</div>
    </div>

    <div id="right">
        <h2>Scores Over Time</h2>
        <div class="legend">
            <span
                style="display:inline-block;width:80px;height:12px;border-radius:2px;background:linear-gradient(to right, #7832a0, #a0a0a0, #ffdc28);vertical-align:middle"></span>
            <span style="font-size:11px">Neg ← Color → Pos</span> &nbsp;|&nbsp; Height = Balance, Saturation = Intensity
        </div>
        <svg id="timeseries" viewBox="0,0,760,310">
            <g transform="translate(70,10)">
                <g transform="translate(0,250)" fill="none" font-size="10" font-family="sans-serif"
                    text-anchor="middle">
                    <path class="domain" stroke="currentColor" d="M0.5,6V0.5H670.5V6"></path>
                    <g class="tick" opacity="1" transform="translate(26.929496874507386,0)">
                        <line stroke="currentColor" y2="6"></line><text fill="currentColor" y="9" dy="0.71em">Aug
                            24</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(72.24345894918333,0)">
                        <line stroke="currentColor" y2="6"></line><text fill="currentColor" y="9" dy="0.71em">Aug
                            31</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(117.55742102385926,0)">
                        <line stroke="currentColor" y2="6"></line><text fill="currentColor" y="9" dy="0.71em">Sep
                            07</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(162.8713830985352,0)">
                        <line stroke="currentColor" y2="6"></line><text fill="currentColor" y="9" dy="0.71em">Sep
                            14</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(208.18534517321115,0)">
                        <line stroke="currentColor" y2="6"></line><text fill="currentColor" y="9" dy="0.71em">Sep
                            21</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(253.4993072478871,0)">
                        <line stroke="currentColor" y2="6"></line><text fill="currentColor" y="9" dy="0.71em">Sep
                            28</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(298.81326932256303,0)">
                        <line stroke="currentColor" y2="6"></line><text fill="currentColor" y="9" dy="0.71em">Oct
                            05</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(344.127231397239,0)">
                        <line stroke="currentColor" y2="6"></line><text fill="currentColor" y="9" dy="0.71em">Oct
                            12</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(389.4411934719149,0)">
                        <line stroke="currentColor" y2="6"></line><text fill="currentColor" y="9" dy="0.71em">Oct
                            19</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(434.75515554659086,0)">
                        <line stroke="currentColor" y2="6"></line><text fill="currentColor" y="9" dy="0.71em">Oct
                            26</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(480.33884358599704,0)">
                        <line stroke="currentColor" y2="6"></line><text fill="currentColor" y="9" dy="0.71em">Nov
                            02</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(525.6528056606729,0)">
                        <line stroke="currentColor" y2="6"></line><text fill="currentColor" y="9" dy="0.71em">Nov
                            09</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(570.9667677353489,0)">
                        <line stroke="currentColor" y2="6"></line><text fill="currentColor" y="9" dy="0.71em">Nov
                            16</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(616.2807298100248,0)">
                        <line stroke="currentColor" y2="6"></line><text fill="currentColor" y="9" dy="0.71em">Nov
                            23</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(661.5946918847008,0)">
                        <line stroke="currentColor" y2="6"></line><text fill="currentColor" y="9" dy="0.71em">Nov
                            30</text>
                    </g>
                </g>
                <g fill="none" font-size="10" font-family="sans-serif" text-anchor="end">
                    <path class="domain" stroke="currentColor" d="M-6,250.5H0.5V0.5H-6"></path>
                    <g class="tick" opacity="1" transform="translate(0,250.5)">
                        <line stroke="currentColor" x2="-6"></line><text fill="currentColor" x="-9" dy="0.32em">0</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(0,225.5)">
                        <line stroke="currentColor" x2="-6"></line><text fill="currentColor" x="-9" dy="0.32em">5</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(0,200.5)">
                        <line stroke="currentColor" x2="-6"></line><text fill="currentColor" x="-9"
                            dy="0.32em">10</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(0,175.5)">
                        <line stroke="currentColor" x2="-6"></line><text fill="currentColor" x="-9"
                            dy="0.32em">15</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(0,150.5)">
                        <line stroke="currentColor" x2="-6"></line><text fill="currentColor" x="-9"
                            dy="0.32em">20</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(0,125.5)">
                        <line stroke="currentColor" x2="-6"></line><text fill="currentColor" x="-9"
                            dy="0.32em">25</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(0,100.5)">
                        <line stroke="currentColor" x2="-6"></line><text fill="currentColor" x="-9"
                            dy="0.32em">30</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(0,75.50000000000001)">
                        <line stroke="currentColor" x2="-6"></line><text fill="currentColor" x="-9"
                            dy="0.32em">35</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(0,50.499999999999986)">
                        <line stroke="currentColor" x2="-6"></line><text fill="currentColor" x="-9"
                            dy="0.32em">40</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(0,25.499999999999993)">
                        <line stroke="currentColor" x2="-6"></line><text fill="currentColor" x="-9"
                            dy="0.32em">45</text>
                    </g>
                    <g class="tick" opacity="1" transform="translate(0,0.5)">
                        <line stroke="currentColor" x2="-6"></line><text fill="currentColor" x="-9"
                            dy="0.32em">50</text>
                    </g>
                </g>
                <path fill="none" stroke="#1f77b4" stroke-width="2"
                    d="M0,90L3.207,120L26.295,150L26.607,140L28.839,155L48.408,90L104.182,85L116.536,105L123.049,105L229.464,105L242.333,190L261.77,115L388.433,135L388.74,135L393.079,120L393.113,115L410.623,90L440.08,160L443.008,165L456.72,105L631.045,175L637.509,140L670,195">
                </path>
                <path fill="none" stroke="#d62728" stroke-width="2"
                    d="M0,135L3.207,140L26.295,140L26.607,140L28.839,100L48.408,150L104.182,120L116.536,120L123.049,120L229.464,135L242.333,170L261.77,165L388.433,200L388.74,200L393.079,170L393.113,155L410.623,175L440.08,155L443.008,145L456.72,190L631.045,125L637.509,150L670,180">
                </path>
                <circle class="ptP" cx="0" cy="90" r="4" fill="#1f77b4"></circle>
                <circle class="ptP" cx="3.2065180776512716" cy="120" r="4" fill="#1f77b4"></circle>
                <circle class="ptP" cx="26.29528655405305" cy="150" r="4" fill="#1f77b4"></circle>
                <circle class="ptP" cx="26.606561855629092" cy="140" r="4" fill="#1f77b4"></circle>
                <circle class="ptP" cx="28.83865817299171" cy="155" r="4" fill="#1f77b4"></circle>
                <circle class="ptP" cx="48.4084201776398" cy="90" r="4" fill="#1f77b4"></circle>
                <circle class="ptP" cx="104.1819808448535" cy="84.99999999999999" r="4" fill="#1f77b4"></circle>
                <circle class="ptP" cx="116.53561823828157" cy="105.00000000000001" r="4" fill="#1f77b4"></circle>
                <circle class="ptP" cx="123.0486504249557" cy="105.00000000000001" r="4" fill="#1f77b4"></circle>
                <circle class="ptP" cx="229.46425820709777" cy="105.00000000000001" r="4" fill="#1f77b4"></circle>
                <circle class="ptP" cx="242.33337113943816" cy="190" r="4" fill="#1f77b4"></circle>
                <circle class="ptP" cx="261.76995752240214" cy="114.99999999999999" r="4" fill="#1f77b4"></circle>
                <circle class="ptP" cx="388.4327362775288" cy="135" r="4" fill="#1f77b4"></circle>
                <circle class="ptP" cx="388.73959331795487" cy="135" r="4" fill="#1f77b4"></circle>
                <circle class="ptP" cx="393.07866824434456" cy="120" r="4" fill="#1f77b4"></circle>
                <circle class="ptP" cx="393.1129219433877" cy="114.99999999999999" r="4" fill="#1f77b4"></circle>
                <circle class="ptP" cx="410.6233827748493" cy="90" r="4" fill="#1f77b4"></circle>
                <circle class="ptP" cx="440.07961847851834" cy="160" r="4" fill="#1f77b4"></circle>
                <circle class="ptP" cx="443.00757017309763" cy="164.99999999999997" r="4" fill="#1f77b4"></circle>
                <circle class="ptP" cx="456.71963166442333" cy="105.00000000000001" r="4" fill="#1f77b4"></circle>
                <circle class="ptP" cx="631.0449034417284" cy="175" r="4" fill="#1f77b4"></circle>
                <circle class="ptP" cx="637.5094480406573" cy="140" r="4" fill="#1f77b4"></circle>
                <circle class="ptP" cx="670" cy="195" r="4" fill="#1f77b4"></circle>
                <circle class="ptN" cx="0" cy="135" r="4" fill="#d62728"></circle>
                <circle class="ptN" cx="3.2065180776512716" cy="140" r="4" fill="#d62728"></circle>
                <circle class="ptN" cx="26.29528655405305" cy="140" r="4" fill="#d62728"></circle>
                <circle class="ptN" cx="26.606561855629092" cy="140" r="4" fill="#d62728"></circle>
                <circle class="ptN" cx="28.83865817299171" cy="100" r="4" fill="#d62728"></circle>
                <circle class="ptN" cx="48.4084201776398" cy="150" r="4" fill="#d62728"></circle>
                <circle class="ptN" cx="104.1819808448535" cy="120" r="4" fill="#d62728"></circle>
                <circle class="ptN" cx="116.53561823828157" cy="120" r="4" fill="#d62728"></circle>
                <circle class="ptN" cx="123.0486504249557" cy="120" r="4" fill="#d62728"></circle>
                <circle class="ptN" cx="229.46425820709777" cy="135" r="4" fill="#d62728"></circle>
                <circle class="ptN" cx="242.33337113943816" cy="169.99999999999997" r="4" fill="#d62728"></circle>
                <circle class="ptN" cx="261.76995752240214" cy="164.99999999999997" r="4" fill="#d62728"></circle>
                <circle class="ptN" cx="388.4327362775288" cy="200" r="4" fill="#d62728"></circle>
                <circle class="ptN" cx="388.73959331795487" cy="200" r="4" fill="#d62728"></circle>
                <circle class="ptN" cx="393.07866824434456" cy="169.99999999999997" r="4" fill="#d62728"></circle>
                <circle class="ptN" cx="393.1129219433877" cy="155" r="4" fill="#d62728"></circle>
                <circle class="ptN" cx="410.6233827748493" cy="175" r="4" fill="#d62728"></circle>
                <circle class="ptN" cx="440.07961847851834" cy="155" r="4" fill="#d62728"></circle>
                <circle class="ptN" cx="443.00757017309763" cy="145.00000000000003" r="4" fill="#d62728"></circle>
                <circle class="ptN" cx="456.71963166442333" cy="190" r="4" fill="#d62728"></circle>
                <circle class="ptN" cx="631.0449034417284" cy="125" r="4" fill="#d62728"></circle>
                <circle class="ptN" cx="637.5094480406573" cy="150" r="4" fill="#d62728"></circle>
                <circle class="ptN" cx="670" cy="180" r="4" fill="#d62728"></circle><text x="335" y="288"
                    text-anchor="middle">Date</text><text x="-125" y="-48" text-anchor="middle"
                    transform="rotate(-90)">Score (0–50)</text>
            </g>
        </svg>


    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
    <script>
        (async function () {
            // --- PANAS items
            const ITEMS = ["Interested", "Distressed", "Excited", "Upset", "Strong", "Guilty", "Scared", "Hostile", "Enthusiastic", "Proud", "Irritable", "Alert", "Ashamed", "Inspired", "Nervous", "Determined", "Attentive", "Jittery", "Active", "Afraid"];
            const POS_IDX = [1, 3, 5, 9, 10, 12, 14, 16, 17, 19];
            const NEG_IDX = [2, 4, 6, 7, 8, 11, 13, 15, 18, 20];
            // Create sets for quick lookup (convert to 0-based)
            const POS_ITEMS = new Set(POS_IDX.map(i => ITEMS[i - 1]));
            const NEG_ITEMS = new Set(NEG_IDX.map(i => ITEMS[i - 1]));



            // --- SQLite init
            const SQL = await initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/${f}` });
            const LSKEY = "panas_db";
            const SETTINGS_KEY = "panas_gh_settings";
            function base64ToU8(b64) { if (!b64) return new Uint8Array(); const s = atob(b64); const u = new Uint8Array(s.length); for (let i = 0; i < s.length; i++)u[i] = s.charCodeAt(i); return u; }
            function u8ToBase64(u8) { let s = ""; u8.forEach(b => s += String.fromCharCode(b)); return btoa(s); }
            function persist() { localStorage.setItem(LSKEY, u8ToBase64(db.export())); }

            // GitHub Sync Functions
            function getGHSettings() {
                const saved = localStorage.getItem(SETTINGS_KEY);
                return saved ? JSON.parse(saved) : { token: "", owner: "rlhjansen", repo: "minimal_mood_dashboard", branch: "main", path: "data/entries.json" };
            }

            function saveGHSettings(settings) {
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            }

            function setSyncStatus(msg, isError = false) {
                const el = document.getElementById("syncStatus");
                if (el) {
                    el.textContent = msg;
                    el.style.color = isError ? "#d62728" : "#2ca02c";
                }
            }

            async function syncFromGitHub() {
                const settings = getGHSettings();
                if (!settings.token || !settings.owner || !settings.repo) {
                    console.log("GitHub sync not configured, skipping pull.");
                    return false;
                }

                try {
                    const url = `https://api.github.com/repos/${settings.owner}/${settings.repo}/contents/${settings.path}?ref=${settings.branch}`;
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `token ${settings.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (response.status === 404) {
                        console.log("No remote data file found yet, will create on first push.");
                        return false;
                    }

                    if (!response.ok) {
                        throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();
                    const content = atob(data.content.replace(/\s/g, ''));
                    const entries = JSON.parse(content);

                    if (!Array.isArray(entries) || entries.length === 0) {
                        console.log("No entries in remote file.");
                        return false;
                    }

                    // Merge remote entries into local DB
                    const existingIds = new Set();
                    const res = db.exec("SELECT id FROM entries");
                    if (res.length > 0) {
                        res[0].values.forEach(row => existingIds.add(row[0]));
                    }

                    let importedCount = 0;
                    entries.forEach(entry => {
                        if (!existingIds.has(entry.id)) {
                            const cols = ["id", "ts", "log", ...ITEMS, "positive_score", "negative_score"];
                            const vals = [entry.id, entry.ts, entry.log || "", ...ITEMS.map(k => entry.items[k]), entry.positive_score, entry.negative_score];
                            const q = `INSERT INTO entries (${cols.map(c => '"' + c + '"').join(",")}) VALUES (${cols.map(() => "?").join(",")})`;
                            const stmt = db.prepare(q);
                            stmt.run(vals);
                            stmt.free();
                            importedCount++;
                        }
                    });

                    if (importedCount > 0) {
                        persist();
                        console.log(`Synced ${importedCount} new entries from GitHub.`);
                        setSyncStatus(`Synced ${importedCount} new entries from GitHub.`);
                        return true;
                    } else {
                        console.log("Already up to date with GitHub.");
                        return false;
                    }
                } catch (error) {
                    console.error("Sync from GitHub failed:", error);
                    setSyncStatus(`Sync failed: ${error.message}`, true);
                    return false;
                }
            }

            async function syncToGitHub() {
                const settings = getGHSettings();
                if (!settings.token || !settings.owner || !settings.repo) {
                    console.log("GitHub sync not configured, skipping push.");
                    return;
                }

                try {
                    // First, pull any remote changes to avoid conflicts
                    await syncFromGitHub();

                    const entries = getAllEntries();
                    const content = JSON.stringify(entries, null, 2);
                    const encodedContent = btoa(unescape(encodeURIComponent(content)));

                    // Get current file SHA (fresh after pull)
                    const url = `https://api.github.com/repos/${settings.owner}/${settings.repo}/contents/${settings.path}?ref=${settings.branch}`;
                    let sha = null;

                    const getResponse = await fetch(url, {
                        headers: {
                            'Authorization': `token ${settings.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (getResponse.ok) {
                        const fileData = await getResponse.json();
                        sha = fileData.sha;
                    }

                    // Create or update file
                    const putResponse = await fetch(url.split('?')[0], {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${settings.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Update mood entries (${entries.length} total)`,
                            content: encodedContent,
                            branch: settings.branch,
                            ...(sha && { sha })
                        })
                    });

                    if (!putResponse.ok) {
                        throw new Error(`GitHub API error: ${putResponse.status} ${putResponse.statusText}`);
                    }

                    console.log(`Pushed ${entries.length} entries to GitHub.`);
                    setSyncStatus(`Pushed ${entries.length} entries to GitHub.`);
                } catch (error) {
                    console.error("Sync to GitHub failed:", error);
                    setSyncStatus(`Push failed: ${error.message}`, true);
                }
            }

            let dbBytes = base64ToU8(localStorage.getItem(LSKEY) || "");
            let db = dbBytes.length ? new SQL.Database(dbBytes) : new SQL.Database();

            // base schema
            db.exec(`CREATE TABLE IF NOT EXISTS entries (id INTEGER PRIMARY KEY AUTOINCREMENT, ts TEXT)`);
            const ensureCol = (name, type) => {
                const info = db.exec(`PRAGMA table_info(entries)`)[0]?.values || [];
                const names = info.map(r => r[1]);
                if (!names.includes(name)) { db.exec(`ALTER TABLE entries ADD COLUMN "${name}" ${type}`); }
            };
            ensureCol("log", "TEXT");
            ITEMS.forEach(it => ensureCol(it, "INTEGER NOT NULL DEFAULT 3"));
            ensureCol("positive_score", "INTEGER");
            ensureCol("negative_score", "INTEGER");
            db.exec(`UPDATE entries SET log='' WHERE log IS NULL`);
            persist();

            // Load GitHub settings into UI
            const ghSettings = getGHSettings();
            document.getElementById("ghToken").value = ghSettings.token || "";
            document.getElementById("ghOwner").value = ghSettings.owner || "rlhjansen";
            document.getElementById("ghRepo").value = ghSettings.repo || "minimal_mood_dashboard";
            document.getElementById("ghBranch").value = ghSettings.branch || "main";
            document.getElementById("ghPath").value = ghSettings.path || "data/entries.json";

            // Toggle settings visibility
            document.getElementById("toggleSettings").onclick = () => {
                const box = document.getElementById("settingsBox");
                box.classList.toggle("expanded");
            };

            // Auto-sync from GitHub on page load
            (async () => {
                const synced = await syncFromGitHub();
                if (synced) {
                    refreshFromDb();
                }
            })();

            // Save settings
            document.getElementById("saveSettings").onclick = () => {
                const settings = {
                    token: document.getElementById("ghToken").value.trim(),
                    owner: document.getElementById("ghOwner").value.trim(),
                    repo: document.getElementById("ghRepo").value.trim(),
                    branch: document.getElementById("ghBranch").value.trim(),
                    path: document.getElementById("ghPath").value.trim()
                };
                saveGHSettings(settings);
                setSyncStatus("Settings saved!");
            };

            // Test sync button
            document.getElementById("testSync").onclick = async () => {
                setSyncStatus("Syncing...");
                const synced = await syncFromGitHub();
                if (synced) {
                    refreshFromDb();
                }
                await syncToGitHub();
            };

            // --- Import (.sqlite)
            const importBox = document.getElementById("importBox");
            const fileInput = document.getElementById("fileInput");
            const status = t => document.getElementById("status").textContent = t;
            const setHover = on => importBox.classList.toggle("hover", !!on);

            ["dragenter", "dragover"].forEach(ev => {
                importBox.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); setHover(true); });
            });
            ["dragleave", "dragend", "drop"].forEach(ev => {
                importBox.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); if (ev !== "drop") setHover(false); });
            });
            importBox.addEventListener("click", () => fileInput.click());
            importBox.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); fileInput.click(); } });

            importBox.addEventListener("drop", (e) => {
                setHover(false);
                const f = e.dataTransfer.files?.[0];
                if (f) importDbFromFile(f);
            });
            fileInput.addEventListener("change", () => {
                const f = fileInput.files?.[0];
                if (f) importDbFromFile(f);
                fileInput.value = "";
            });

            async function importDbFromFile(file) {
                try {
                    status(`Importing "${file.name}"...`);
                    const buf = await file.arrayBuffer();
                    const u8 = new Uint8Array(buf);
                    const tmp = new SQL.Database(u8);
                    const needCols = () => {
                        const info = tmp.exec(`PRAGMA table_info(entries)`)[0]?.values || [];
                        const names = new Set(info.map(r => r[1]));
                        if (!names.has("log")) tmp.exec(`ALTER TABLE entries ADD COLUMN "log" TEXT`);
                        ITEMS.forEach(it => { if (!names.has(it)) tmp.exec(`ALTER TABLE entries ADD COLUMN "${it}" INTEGER NOT NULL DEFAULT 3`); });
                        if (!names.has("positive_score")) tmp.exec(`ALTER TABLE entries ADD COLUMN "positive_score" INTEGER`);
                        if (!names.has("negative_score")) tmp.exec(`ALTER TABLE entries ADD COLUMN "negative_score" INTEGER`);
                    };
                    needCols();
                    db = tmp;
                    persist();
                    refreshFromDb();
                    status(`Imported ${file.name} and refreshed from latest entry.`);
                } catch (err) {
                    console.error(err);
                    status("Import failed: not a valid PANAS SQLite file?");
                    alert("Import failed. Ensure you're selecting the exported panas.sqlite file.");
                }
            }

            // Helpers to read latest entry and refresh UI
            function getMostRecentEntry() {
                const res = db.exec(`SELECT ${ITEMS.map(n => `"${n}"`).join(",")} FROM entries ORDER BY id DESC LIMIT 1`);
                if (!res.length) return null;
                const row = res[0].values[0];
                const o = {}; ITEMS.forEach((n, i) => o[n] = row[i]);
                return o;
            }

            // --- Windrose setup
            const size = 620, radius = size / 2 - 70, levels = 5;
            // Clear any existing content from saved HTML
            d3.select("#radar").selectAll("*").remove();
            const svg = d3.select("#radar").attr("viewBox", [0, 0, size, size]).append("g").attr("transform", `translate(${size / 2},${size / 2})`);
            let labels = d3.shuffle(ITEMS.slice());
            let values = {};

            const last = getMostRecentEntry();
            ITEMS.forEach(l => values[l] = last ? (last[l] ?? 3) : 3);

            const step = radius / levels;
            const angleForIndex = i => (i / labels.length) * 2 * Math.PI;
            const posOnSpoke = (angle, v) => [Math.cos(angle) * (v * step), Math.sin(angle) * (v * step)];

            for (let l = 1; l <= levels; l++) { svg.append("circle").attr("r", l * step).attr("class", "grid"); }

            // Wedge background group (inserted before axes so axes draw on top)
            const wedgeGroup = svg.append("g").attr("class", "wedges");

            // Helper to create arc path for a wedge
            function wedgePath(startAngle, endAngle, innerRadius, outerRadius) {
                const arc = d3.arc()
                    .innerRadius(innerRadius)
                    .outerRadius(outerRadius)
                    .startAngle(startAngle)
                    .endAngle(endAngle);
                return arc();
            }

            // Get wedge color based on item type (pos/neg) and value
            function getWedgeColor(label, value) {
                const isPositive = POS_ITEMS.has(label);
                // Saturation: value 1→5 maps to 0→1
                const sat = (value - 1) / 4;
                const baseColor = isPositive ? d3.rgb(255, 220, 40) : d3.rgb(120, 50, 160); // bright yellow / deep purple
                const gray = d3.rgb(240, 240, 240); // light gray base
                return d3.interpolateRgb(gray, baseColor)(sat);
            }

            function drawWedges() {
                wedgeGroup.selectAll("path").remove();
                const n = labels.length;
                const wedgeAngle = (2 * Math.PI) / n;
                labels.forEach((label, i) => {
                    const startAngle = angleForIndex(i) - wedgeAngle / 2 + Math.PI / 2;
                    const endAngle = startAngle + wedgeAngle;
                    const val = values[label];
                    wedgeGroup.append("path")
                        .attr("d", wedgePath(startAngle, endAngle, 0, radius))
                        .attr("fill", getWedgeColor(label, val));
                });
            }

            function drawAxes() {
                svg.selectAll(".axis").remove();
                svg.selectAll(".label").remove();
                labels.forEach((label, i) => {
                    const a = angleForIndex(i);
                    svg.append("line").attr("class", "axis").attr("x1", 0).attr("y1", 0).attr("x2", Math.cos(a) * radius).attr("y2", Math.sin(a) * radius);
                    svg.append("text").attr("class", "label").attr("x", Math.cos(a) * (radius + 20)).attr("y", Math.sin(a) * (radius + 20)).text(label);
                });
            }
            drawAxes();

            const refPoly = svg.append("path").attr("class", "reference");
            const curPoly = svg.append("path").attr("class", "current");
            const previewPoly = svg.append("path").attr("class", "preview");
            const monthlyPoly = svg.append("path").attr("class", "monthly");
            const handleGroup = svg.append("g");

            function updateHandlePositions() {
                handleGroup.selectAll("circle")
                    .attr("cx", d => posOnSpoke(d.angle, values[d.label])[0])
                    .attr("cy", d => posOnSpoke(d.angle, values[d.label])[1]);
            }

            let handles = handleGroup.selectAll("circle")
                .data(labels.map((label, i) => ({ label, angle: angleForIndex(i) })))
                .join("circle")
                .attr("class", "handle")
                .attr("r", 6)
                .attr("cx", d => posOnSpoke(d.angle, values[d.label])[0])
                .attr("cy", d => posOnSpoke(d.angle, values[d.label])[1])
                .call(d3.drag().on("drag", function (ev, d) {
                    const r = Math.min(radius, Math.hypot(ev.x, ev.y));
                    let val = Math.round(r / step);
                    val = Math.max(1, Math.min(5, val));
                    values[d.label] = val;
                    d3.select(this).attr("cx", posOnSpoke(d.angle, val)[0]).attr("cy", posOnSpoke(d.angle, val)[1]);
                    drawPolygons();
                    drawMonthlyAverage(); // keep monthly visible while editing
                }));

            function polygonForVals(valMap) { return labels.map((lbl, i) => posOnSpoke(angleForIndex(i), valMap[lbl])); }

            function drawPolygons() {
                drawWedges(); // Update wedge background colors
                const ptsCur = polygonForVals(values);
                curPoly.attr("d", d3.line().curve(d3.curveLinearClosed)(ptsCur));
                const ref = getMostRecentEntry();
                if (ref) {
                    const ptsRef = polygonForVals(ref);
                    refPoly.attr("d", d3.line().curve(d3.curveLinearClosed)(ptsRef));
                } else { refPoly.attr("d", null); }
            }

            function drawPreview(valMapOrNull) {
                if (!valMapOrNull) { previewPoly.attr("d", null); return; }
                const pts = polygonForVals(valMapOrNull);
                previewPoly.attr("d", d3.line().curve(d3.curveLinearClosed)(pts));
            }

            function computeMonthlyAverage() {
                const sinceISO = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();
                const q = `SELECT ${ITEMS.map(n => `"${n}"`).join(",")} FROM entries WHERE ts>='${sinceISO}'`;
                const res = db.exec(q);
                if (!res.length) return null;
                const rows = res[0].values;
                const sums = Object.fromEntries(ITEMS.map(n => [n, 0]));
                rows.forEach(r => { ITEMS.forEach((n, i) => { sums[n] += (r[i] ?? 3); }); });
                const cnt = rows.length;
                const avg = {}; ITEMS.forEach(n => avg[n] = sums[n] / cnt);
                return { avg, count: cnt };
            }

            function drawMonthlyAverage() {
                const m = computeMonthlyAverage();
                if (!m) { monthlyPoly.attr("d", null); status("No entries in last 30 days."); return; }
                const pts = polygonForVals(m.avg);
                monthlyPoly.attr("d", d3.line().curve(d3.curveLinearClosed)(pts));
                status(`30-day average (${m.count} ${m.count === 1 ? "entry" : "entries"})`);
            }

            // Initial draw
            drawPolygons();
            drawMonthlyAverage();

            // Randomize layout (keep values)
            document.getElementById("randomize").onclick = () => {
                labels = d3.shuffle(labels.slice());
                handles = handleGroup.selectAll("circle")
                    .data(labels.map((label, i) => ({ label, angle: angleForIndex(i) })))
                    .join("circle")
                    .attr("class", "handle")
                    .attr("r", 6)
                    .attr("cx", d => posOnSpoke(d.angle, values[d.label])[0])
                    .attr("cy", d => posOnSpoke(d.angle, values[d.label])[1])
                    .call(d3.drag().on("drag", function (ev, d) {
                        const r = Math.min(radius, Math.hypot(ev.x, ev.y));
                        let val = Math.round(r / step);
                        val = Math.max(1, Math.min(5, val));
                        values[d.label] = val;
                        d3.select(this).attr("cx", posOnSpoke(d.angle, val)[0]).attr("cy", posOnSpoke(d.angle, val)[1]);
                        drawPolygons();
                        drawMonthlyAverage();
                    }));
                drawAxes();
                drawPolygons();
                drawPreview(null);
                drawMonthlyAverage();
                status("Petals randomized (values preserved).");
            };

            // Save
            document.getElementById("save").onclick = async () => {
                const missing = ITEMS.filter(k => !(values[k] >= 1 && values[k] <= 5));
                if (missing.length) { status("Please rate all 20 items (1–5)."); return; }

                const ts = new Date().toISOString();
                const log = document.getElementById("log").value.trim();
                const getByIndex = i1 => values[ITEMS[i1 - 1]];
                const posScore = POS_IDX.reduce((s, i) => s + getByIndex(i), 0);
                const negScore = NEG_IDX.reduce((s, i) => s + getByIndex(i), 0);

                const cols = ["ts", "log", ...ITEMS, "positive_score", "negative_score"];
                const q = `INSERT INTO entries (${cols.map(c => '"' + c + '"').join(",")}) VALUES (${cols.map(() => "?").join(",")})`;
                const vals = [ts, log, ...ITEMS.map(k => values[k]), posScore, negScore];
                const stmt = db.prepare(q); stmt.run(vals); stmt.free(); persist();

                const latest = getMostRecentEntry();
                ITEMS.forEach(k => values[k] = (latest && latest[k] != null) ? latest[k] : 3);
                updateHandlePositions();
                drawPolygons();
                drawPreview(null);
                drawTimeSeries();
                drawMonthlyAverage();

                downloadDBAndPage();
                status("Saved & downloaded database + page.");
                document.getElementById("log").value = "";

                // Auto-sync to GitHub after save
                await syncToGitHub();
            };

            // Clear
            document.getElementById("clear").onclick = () => {
                if (!confirm("Delete all saved entries?")) return;
                db.exec("DELETE FROM entries"); persist();
                ITEMS.forEach(k => values[k] = 3);
                updateHandlePositions();
                drawPolygons(); drawPreview(null); drawTimeSeries();
                monthlyPoly.attr("d", null);
                status("Database cleared.");
            };

            // ===== Copy JSON =====
            function getAllEntries() {
                const res = db.exec(`SELECT id, ts, log, positive_score, negative_score, ${ITEMS.map(n => `"${n}"`).join(",")} FROM entries ORDER BY ts ASC`);
                if (!res.length) return [];
                const rows = res[0].values;
                return rows.map(r => {
                    const obj = { id: r[0], ts: r[1], log: r[2] || "", positive_score: r[3], negative_score: r[4], items: {} };
                    ITEMS.forEach((name, idx) => obj.items[name] = r[5 + idx]);
                    return obj;
                });
            }

            async function copyJSON() {
                const data = getAllEntries();
                const text = JSON.stringify(data, null, 2);
                if (!data.length) { status("No entries to copy."); return; }
                try {
                    await navigator.clipboard.writeText(text);
                    status(`Copied ${data.length} ${data.length === 1 ? "entry" : "entries"} to clipboard as JSON.`);
                } catch (e) {
                    // Fallback: try execCommand, then download
                    try {
                        const ta = document.createElement("textarea");
                        ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta);
                        status(`Copied ${data.length} ${data.length === 1 ? "entry" : "entries"} to clipboard as JSON.`);
                    } catch (err) {
                        const blob = new Blob([text], { type: "application/json" });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a"); a.href = url; a.download = "panas.json"; a.click(); URL.revokeObjectURL(url);
                        status("Clipboard blocked. Downloaded panas.json instead.");
                    }
                }
            }

            document.getElementById("copyJson").onclick = copyJSON;

            // Timeseries
            const tsvg = d3.select("#timeseries").attr("viewBox", [0, 0, 760, 310]);
            const tooltip = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);

            function drawTimeSeries() {
                tsvg.selectAll("*").remove();
                const res = db.exec(`SELECT ts, positive_score, negative_score, log, ${ITEMS.map(n => `"${n}"`).join(",")} FROM entries ORDER BY ts ASC`);
                if (!res.length) return;
                const rows = res[0].values.map(r => {
                    const itemVals = {}; ITEMS.forEach((name, idx) => itemVals[name] = r[4 + idx]);
                    const pos = r[1], neg = r[2];
                    const total = pos + neg; // total intensity (20-100 range, since each is 10-50)
                    // Log ratio: log(pos/neg), symmetric around 0 when equal
                    // Range is roughly -1.6 to +1.6 (log(10/50) to log(50/10))
                    const logRatio = Math.log(pos / neg);
                    return { ts: new Date(r[0]), pos, neg, diff: pos - neg, total, logRatio, log: r[3] || "", itemVals };
                });

                // Calculate saturation scale based on YOUR actual score range
                // Full 0→1 saturation range mapped to your data's min→max
                const totalMin = d3.min(rows, d => d.total);
                const totalMax = d3.max(rows, d => d.total);
                const satScale = d3.scaleLinear().domain([totalMin, totalMax]).range([0, 1]).clamp(true);

                // Map log ratio to 0-1 for color interpolation
                // Use YOUR actual data range so the most extreme entry gets full color
                const absLogRatioMax = d3.max(rows, d => Math.abs(d.logRatio));
                const logRatioScale = d3.scaleLinear().domain([-absLogRatioMax, absLogRatioMax]).range([0, 1]).clamp(true);

                // Color function: log ratio determines color (yellow for positive, purple for negative)
                // We interpolate in RGB space
                function getColor(d) {
                    // logRatio: negative = more negative affect, 0 = equal, positive = more positive affect
                    const sat = satScale(d.total);
                    // Purple for negative, yellow for positive
                    const purple = d3.rgb(120, 50, 160);  // deep purple
                    const yellow = d3.rgb(255, 220, 40);  // bright yellow

                    // Map log ratio to 0-1 range for interpolation
                    const colorT = logRatioScale(d.logRatio);
                    const baseColor = d3.interpolateRgb(purple, yellow)(colorT);

                    // Apply saturation: interpolate between gray and the base color
                    const gray = d3.rgb(160, 160, 160);
                    return d3.interpolateRgb(gray, baseColor)(sat);
                }

                const margin = { l: 70, r: 20, t: 10, b: 50 };
                const W = 760, H = 310, iw = W - margin.l - margin.r, ih = H - margin.t - margin.b;
                const g = tsvg.append("g").attr("transform", `translate(${margin.l},${margin.t})`);
                const x = d3.scaleTime().domain(d3.extent(rows, d => d.ts)).range([0, iw]);
                const y = d3.scaleLinear().domain([-40, 40]).range([ih, 0]); // centered for difference

                g.append("g").attr("transform", `translate(0,${ih})`).call(d3.axisBottom(x));
                g.append("g").call(d3.axisLeft(y));

                // Add zero line for reference
                const y0 = y(0);
                g.append("line").attr("x1", 0).attr("x2", iw).attr("y1", y0).attr("y2", y0)
                    .attr("stroke", "#999").attr("stroke-dasharray", "4,4").attr("opacity", 0.7);

                // Draw filled bars from zero to each point
                const barWidth = Math.max(2, Math.min(20, iw / rows.length * 0.7));
                g.selectAll(".bar").data(rows).enter().append("rect").attr("class", "bar")
                    .attr("x", d => x(d.ts) - barWidth / 2)
                    .attr("y", d => d.diff >= 0 ? y(d.diff) : y0)
                    .attr("width", barWidth)
                    .attr("height", d => Math.abs(y(d.diff) - y0))
                    .attr("fill", d => getColor(d))
                    .attr("opacity", 0.7);

                // Draw line connecting points
                const lineDiff = d3.line().x(d => x(d.ts)).y(d => y(d.diff));
                g.append("path").datum(rows).attr("fill", "none").attr("stroke", "#333").attr("stroke-width", 1.5).attr("d", lineDiff);

                const showTip = (ev, d) => {
                    tooltip.style("opacity", 1)
                        .html(`<b>${d.ts.toLocaleString()}</b><br>Balance: ${d.diff} (Pos: ${d.pos}, Neg: ${d.neg})<br>Log ratio: ${d.logRatio.toFixed(2)}${d.log ? `<div style="margin-top:4px;opacity:.9">${d.log.replace(/</g, "&lt;")}</div>` : ""}`)
                        .style("left", (ev.pageX + 10) + "px").style("top", (ev.pageY - 28) + "px");
                };
                const hideTip = () => tooltip.style("opacity", 0);

                function onOver(ev, d) {
                    showTip(ev, d);
                    drawMonthlyAverage();    // ensure monthly is drawn once (for status), then hide
                    monthlyPoly.attr("d", null);
                    drawPreview(d.itemVals);
                    status(`Previewing ${d.ts.toLocaleString()} on windrose`);
                }
                function onMove(ev, d) { showTip(ev, d); }
                function onOut() {
                    hideTip();
                    drawPreview(null);
                    drawMonthlyAverage();    // restore monthly average on idle
                }

                // Interactive circles on top
                g.selectAll(".pt").data(rows).enter().append("circle").attr("class", "pt")
                    .attr("cx", d => x(d.ts)).attr("cy", d => y(d.diff)).attr("r", 5)
                    .attr("fill", d => getColor(d)).attr("stroke", "#333").attr("stroke-width", 1)
                    .on("mouseover", onOver).on("mousemove", onMove).on("mouseout", onOut);

                g.append("text").attr("x", iw / 2).attr("y", ih + 38).attr("text-anchor", "middle").text("Date");
                g.append("text").attr("x", -ih / 2).attr("y", -48).attr("text-anchor", "middle").attr("transform", "rotate(-90)").text("Balance (−40 to +40)");
            }
            drawTimeSeries();

            function refreshFromDb() {
                const latest = getMostRecentEntry();
                ITEMS.forEach(k => values[k] = (latest && latest[k] != null) ? latest[k] : 3);
                updateHandlePositions();
                drawPolygons();
                drawPreview(null);
                drawTimeSeries();
                drawMonthlyAverage();
            }

            function downloadDBAndPage() {
                const dbBlob = new Blob([db.export()], { type: "application/x-sqlite3" });
                const dbUrl = URL.createObjectURL(dbBlob);
                const adb = document.createElement("a");
                adb.href = dbUrl; adb.download = "panas.sqlite"; adb.click();
                URL.revokeObjectURL(dbUrl);
                const html = document.documentElement.outerHTML;
                const pageBlob = new Blob([html], { type: "text/html" });
                const pageUrl = URL.createObjectURL(pageBlob);
                const ap = document.createElement("a");
                ap.href = pageUrl; ap.download = "panas.html"; ap.click();
                URL.revokeObjectURL(pageUrl);
            }

            // Initial alignment
            updateHandlePositions();
            drawPolygons();
        })();
    </script>


    <div class="tooltip" style="opacity: 0;"></div>


    <div class="tooltip" style="opacity: 0;"></div>
</body>

</html>