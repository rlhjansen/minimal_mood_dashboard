<html lang="en"><head>
    <meta charset="utf-8">
    <title>PANAS-GEN Windrose + History</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        :root {
            --pad: 18px
        }

        body {
            font-family: system-ui, Arial, sans-serif;
            margin: 0;
            padding: var(--pad);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--pad)
        }

        h2 {
            margin: .2rem 0 .6rem
        }

        #left,
        #right {
            min-width: 320px
        }

        svg {
            width: 100%;
            height: 620px
        }

        svg#timeseries {
            height: 310px
        }

        .grid circle {
            fill: none;
            stroke: #eee
        }

        .axis line {
            stroke: #ccc
        }

        .label {
            font-size: 11px;
            text-anchor: middle
        }

        .handle {
            fill: #1f77b4;
            cursor: pointer
        }

        .current {
            fill: rgba(31, 119, 180, .25);
            stroke: #1f77b4;
            stroke-width: 2
        }

        .reference {
            fill: none;
            stroke: #888;
            stroke-width: 2;
            stroke-dasharray: 6, 6
        }

        .preview {
            fill: rgba(128, 0, 128, .12);
            stroke: purple;
            stroke-width: 2;
            stroke-dasharray: 4, 6
        }

        .monthly {
            fill: rgba(0, 128, 0, .10);
            stroke: green;
            stroke-width: 2;
            stroke-dasharray: 6, 4
        }

        .controls {
            display: flex;
            gap: .5rem;
            flex-wrap: wrap;
            margin-top: .5rem
        }

        button {
            padding: .5rem .8rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fff;
            cursor: pointer
        }

        button:hover {
            background: #f5f5f5
        }

        #status {
            font-size: .9rem;
            color: #666;
            margin-top: .4rem
        }

        .legend {
            display: flex;
            gap: 12px;
            align-items: center;
            margin: .3rem 0 .8rem
        }

        .sw {
            display: inline-block;
            width: 16px;
            height: 10px;
            border-radius: 2px
        }

        .sw.pos {
            background: #ffdc28
        }

        .sw.neg {
            background: #7832a0
        }

        .sw.extraversion {
            background: #ff7f0e
        }

        .sw.agreeableness {
            background: #2ca02c
        }

        .sw.conscientiousness {
            background: #9467bd
        }

        .sw.neuroticism {
            background: #8c564b
        }

        .sw.openness {
            background: #e377c2
        }

        textarea {
            width: 100%;
            height: 80px;
            margin-top: .6rem;
            padding: .4rem;
            font-family: inherit;
            font-size: 14px
        }

        .tooltip {
            position: absolute;
            pointer-events: none;
            background: rgba(0, 0, 0, .75);
            color: #fff;
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            max-width: 360px;
            line-height: 1.35
        }

        .import-box {
            margin: .6rem 0;
            padding: 14px;
            border: 2px dashed #bbb;
            border-radius: 10px;
            text-align: center;
            font-size: .95rem;
            color: #555;
            user-select: none;
            cursor: pointer
        }

        .import-box strong {
            display: block;
            margin-bottom: .25rem
        }

        .import-box.hover {
            background: #fafafa;
            border-color: #888
        }

        .import-help {
            font-size: .85rem;
            color: #777;
            margin-top: .25rem
        }

        .row {
            display: grid;
            grid-template-columns: 1fr;
            gap: .6rem
        }

        .settings-toggle {
            margin-bottom: .5rem;
        }

        .settings-toggle button {
            font-size: 12px;
            padding: .4rem .6rem;
        }

        .settings-box {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            background: #f9f9f9;
            margin-bottom: 1rem;
            display: none;
        }

        .settings-box.expanded {
            display: block;
        }

        .settings-box input {
            width: 100%;
            padding: .5rem;
            margin-top: .3rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }

        .settings-box label {
            display: block;
            margin-top: .8rem;
            font-weight: 600;
            font-size: 13px;
        }

        .settings-box button {
            margin-top: .8rem;
        }

        .sync-status {
            margin-top: .5rem;
            font-size: 12px;
            color: #666;
        }

        /* ---- Intent Calibration section ---- */
        #intent-section {
            border-top: 2px solid #eee;
            padding-top: 1rem;
            margin-top: .8rem;
        }

        .sleep-row {
            display: flex;
            align-items: center;
            gap: .5rem;
            margin-top: .4rem;
        }
        .sleep-row label { font-size: 13px; font-weight: 600; white-space: nowrap; }
        .sleep-row input[type="number"] {
            width: 70px;
            padding: .3rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
        }
        #last-entry-date {
            font-size: 11px;
            color: #888;
            margin-left: auto;
        }
        #last-entry-date .fresh { color: #2a7; }
        #last-entry-date .stale { color: #c63; }
        #intent-section h2 { margin: 0 0 .8rem; }

        .intent-form {
            display: grid;
            gap: .55rem;
            max-width: 640px;
        }
        .intent-field label {
            display: block;
            font-weight: 600;
            font-size: 13px;
            margin-bottom: .15rem;
        }
        .intent-field textarea,
        .intent-field input[type="text"] {
            width: 100%;
            padding: .4rem;
            font-family: inherit;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .intent-field--inline {
            display: flex;
            align-items: center;
            gap: .5rem;
        }
        .intent-field--inline label { margin: 0; white-space: nowrap; }
        .intent-field--inline input[type="number"] {
            width: 80px;
            padding: .35rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
        }
        .intent-actions {
            display: flex;
            align-items: center;
            gap: .6rem;
            margin-top: .2rem;
        }
        .intent-status {
            font-size: 12px;
            color: #666;
        }

        /* notification / warning banners */
        .intent-note {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: .7rem 1rem;
            margin-bottom: .7rem;
            font-size: 14px;
        }
        .intent-drift {
            background: #f0f0f0;
            border-left: 3px solid #999;
            padding: .55rem 1rem;
            margin-bottom: .7rem;
            font-size: 13px;
        }
        .intent-collapse {
            border-left: 3px solid #d9534f;
            padding: .55rem 1rem;
            margin-bottom: .7rem;
            font-size: 13px;
            background: #fff0f0;
        }

        /* history entries */
        .intent-history { margin-top: 1rem; max-width: 640px; }
        .intent-history summary { cursor: pointer; }
        .intent-entry {
            border-bottom: 1px solid #eee;
            padding: .45rem 0;
            font-size: 13px;
        }
        .intent-entry-head {
            display: flex;
            align-items: center;
            gap: .5rem;
            flex-wrap: wrap;
        }
        .ie-time   { color: #555; font-weight: 600; }
        .ie-align  { color: #888; font-size: 12px; }
        .ie-text   { margin-top: .15rem; color: #444; }
        .ie-sleep  { margin-top: .1rem; font-size: 12px; color: #888; }
        .ie-badge  {
            display: inline-block;
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .ie-badge--drift  { background: #fdd; color: #a33; }
        .ie-badge--target { background: #e8e0f0; color: #5b3a7a; }

        /* gentle pulse when check-in is due */
        @keyframes intent-pulse { 0%,100%{border-color:#eee} 50%{border-color:#ffc107} }
        #intent-section.intent-highlight { animation: intent-pulse 2s ease-in-out 3; }
    </style>
</head>

<body>
    <div id="left">
        <h2>PANAS-GEN Windrose (drag petals)</h2>

        <div class="row">
            <div class="settings-toggle">
                <button id="toggleSettings">⚙️ GitHub Sync Settings</button>
            </div>
            <div class="settings-box" id="settingsBox">
                <strong>GitHub Sync Settings</strong>
                <label>GitHub Token (with repo permissions):</label>
                <input id="ghToken" type="password" placeholder="ghp_...">
                <label>Owner:</label>
                <input id="ghOwner" type="text" placeholder="rlhjansen">
                <label>Repo:</label>
                <input id="ghRepo" type="text" placeholder="minimal_mood_dashboard">
                <label>Branch:</label>
                <input id="ghBranch" type="text" placeholder="main">
                <label>Data file path:</label>
                <input id="ghPath" type="text" placeholder="data/entries.json">
                <button id="saveSettings">Save Settings</button>
                <button id="testSync">Test Sync Now</button>
                <div class="sync-status" id="syncStatus"></div>
            </div>
        </div>

        <div class="row">
            <div id="importBox" class="import-box" tabindex="0">
                <strong>Import database (.sqlite)</strong>
                Drop file here or click to choose
                <div class="import-help">Replaces the in-browser database; UI refreshes from the newest entry.</div>
                <input id="fileInput" type="file" accept=".sqlite,application/x-sqlite3,application/octet-stream" style="display:none">
            </div>
        </div>

        <svg id="radar" viewBox="0,0,620,620">
            
        <g transform="translate(310,310)"><circle r="48" class="grid"></circle><circle r="96" class="grid"></circle><circle r="144" class="grid"></circle><circle r="192" class="grid"></circle><circle r="240" class="grid"></circle><g class="wedges"><path d="M237.045,-37.544A240,240,0,0,1,237.045,37.544L0,0Z" fill="rgb(240, 240, 240)"></path><path d="M237.045,37.544A240,240,0,0,1,213.842,108.958L0,0Z" fill="rgb(180, 145, 200)"></path><path d="M213.842,108.958A240,240,0,0,1,169.706,169.706L0,0Z" fill="rgb(120, 50, 160)"></path><path d="M169.706,169.706A240,240,0,0,1,108.958,213.842L0,0Z" fill="rgb(240, 240, 240)"></path><path d="M108.958,213.842A240,240,0,0,1,37.544,237.045L0,0Z" fill="rgb(240, 240, 240)"></path><path d="M37.544,237.045A240,240,0,0,1,-37.544,237.045L0,0Z" fill="rgb(210, 193, 220)"></path><path d="M-37.544,237.045A240,240,0,0,1,-108.958,213.842L0,0Z" fill="rgb(240, 240, 240)"></path><path d="M-108.958,213.842A240,240,0,0,1,-169.706,169.706L0,0Z" fill="rgb(240, 240, 240)"></path><path d="M-169.706,169.706A240,240,0,0,1,-213.842,108.958L0,0Z" fill="rgb(240, 240, 240)"></path><path d="M-213.842,108.958A240,240,0,0,1,-237.045,37.544L0,0Z" fill="rgb(240, 240, 240)"></path><path d="M-237.045,37.544A240,240,0,0,1,-237.045,-37.544L0,0Z" fill="rgb(248, 230, 140)"></path><path d="M-237.045,-37.544A240,240,0,0,1,-213.842,-108.958L0,0Z" fill="rgb(240, 240, 240)"></path><path d="M-213.842,-108.958A240,240,0,0,1,-169.706,-169.706L0,0Z" fill="rgb(240, 240, 240)"></path><path d="M-169.706,-169.706A240,240,0,0,1,-108.958,-213.842L0,0Z" fill="rgb(240, 240, 240)"></path><path d="M-108.958,-213.842A240,240,0,0,1,-37.544,-237.045L0,0Z" fill="rgb(180, 145, 200)"></path><path d="M-37.544,-237.045A240,240,0,0,1,37.544,-237.045L0,0Z" fill="rgb(150, 98, 180)"></path><path d="M37.544,-237.045A240,240,0,0,1,108.958,-213.842L0,0Z" fill="rgb(244, 235, 190)"></path><path d="M108.958,-213.842A240,240,0,0,1,169.706,-169.706L0,0Z" fill="rgb(244, 235, 190)"></path><path d="M169.706,-169.706A240,240,0,0,1,213.842,-108.958L0,0Z" fill="rgb(244, 235, 190)"></path><path d="M213.842,-108.958A240,240,0,0,1,237.045,-37.544L0,0Z" fill="rgb(240, 240, 240)"></path></g><line class="axis" x1="0" y1="0" x2="240" y2="0"></line><text class="label" x="260" y="0">Interested</text><line class="axis" x1="0" y1="0" x2="228.25356391083685" y2="74.16407864998737"></line><text class="label" x="247.27469423673992" y="80.34441853748632">Distressed</text><line class="axis" x1="0" y1="0" x2="194.1640786499874" y2="141.06846055019355"></line><text class="label" x="210.34441853748635" y="152.824165596043">Nervous</text><line class="axis" x1="0" y1="0" x2="141.06846055019355" y2="194.1640786499874"></line><text class="label" x="152.824165596043" y="210.34441853748635">Active</text><line class="axis" x1="0" y1="0" x2="74.16407864998739" y2="228.25356391083685"></line><text class="label" x="80.34441853748633" y="247.27469423673992">Jittery</text><line class="axis" x1="0" y1="0" x2="1.469576158976824e-14" y2="240"></line><text class="label" x="1.592040838891559e-14" y="260">Upset</text><line class="axis" x1="0" y1="0" x2="-74.16407864998736" y2="228.25356391083687"></line><text class="label" x="-80.3444185374863" y="247.27469423673995">Strong</text><line class="axis" x1="0" y1="0" x2="-141.06846055019352" y2="194.1640786499874"></line><text class="label" x="-152.82416559604297" y="210.34441853748635">Ashamed</text><line class="axis" x1="0" y1="0" x2="-194.16407864998737" y2="141.06846055019358"></line><text class="label" x="-210.34441853748632" y="152.82416559604303">Proud</text><line class="axis" x1="0" y1="0" x2="-228.25356391083685" y2="74.1640786499874"></line><text class="label" x="-247.27469423673992" y="80.34441853748635">Excited</text><line class="axis" x1="0" y1="0" x2="-240" y2="2.939152317953648e-14"></line><text class="label" x="-260" y="3.184081677783118e-14">Determined</text><line class="axis" x1="0" y1="0" x2="-228.25356391083685" y2="-74.16407864998746"></line><text class="label" x="-247.27469423673992" y="-80.3444185374864">Enthusiastic</text><line class="axis" x1="0" y1="0" x2="-194.1640786499874" y2="-141.06846055019352"></line><text class="label" x="-210.34441853748638" y="-152.82416559604297">Hostile</text><line class="axis" x1="0" y1="0" x2="-141.06846055019358" y2="-194.16407864998737"></line><text class="label" x="-152.82416559604303" y="-210.34441853748632">Irritable</text><line class="axis" x1="0" y1="0" x2="-74.16407864998742" y2="-228.25356391083685"></line><text class="label" x="-80.34441853748636" y="-247.27469423673992">Afraid</text><line class="axis" x1="0" y1="0" x2="-4.408728476930471e-14" y2="-240"></line><text class="label" x="-4.776122516674677e-14" y="-260">Scared</text><line class="axis" x1="0" y1="0" x2="74.16407864998733" y2="-228.25356391083687"></line><text class="label" x="80.34441853748628" y="-247.27469423673995">Inspired</text><line class="axis" x1="0" y1="0" x2="141.0684605501935" y2="-194.1640786499874"></line><text class="label" x="152.82416559604295" y="-210.34441853748638">Alert</text><line class="axis" x1="0" y1="0" x2="194.16407864998737" y2="-141.0684605501936"></line><text class="label" x="210.34441853748632" y="-152.8241655960431">Attentive</text><line class="axis" x1="0" y1="0" x2="228.25356391083685" y2="-74.16407864998745"></line><text class="label" x="247.27469423673992" y="-80.34441853748639">Guilty</text><path class="reference" d="M48,0L136.952,44.498L194.164,141.068L28.214,38.833L14.833,45.651L0,96L-14.833,45.651L-28.214,38.833L-38.833,28.214L-45.651,14.833L-144,0L-45.651,-14.833L-38.833,-28.214L-28.214,-38.833L-44.498,-136.952L0,-192L29.666,-91.301L56.427,-77.666L77.666,-56.427L45.651,-14.833Z"></path><path class="current" d="M48,0L136.952,44.498L194.164,141.068L28.214,38.833L14.833,45.651L0,96L-14.833,45.651L-28.214,38.833L-38.833,28.214L-45.651,14.833L-144,0L-45.651,-14.833L-38.833,-28.214L-28.214,-38.833L-44.498,-136.952L0,-192L29.666,-91.301L56.427,-77.666L77.666,-56.427L45.651,-14.833Z"></path><path class="preview"></path><path class="monthly" d="M104.727,0L161.853,52.589L148.271,107.725L55.572,76.489L30.565,94.068L0,142.545L-27.868,85.768L-65.832,90.61L-76.489,55.572L-65.018,21.126L-113.455,0L-77.468,-25.171L-81.196,-58.992L-69.252,-95.317L-48.544,-149.402L0,-178.909L29.666,-91.301L55.572,-76.489L102.377,-74.382L142.486,-46.296Z"></path><g><circle class="handle" r="6" cx="48" cy="0"></circle><circle class="handle" r="6" cx="136.9521383465021" cy="44.498447189992426"></circle><circle class="handle" r="6" cx="194.1640786499874" cy="141.06846055019355"></circle><circle class="handle" r="6" cx="28.21369211003871" cy="38.83281572999748"></circle><circle class="handle" r="6" cx="14.832815729997478" cy="45.65071278216737"></circle><circle class="handle" r="6" cx="5.878304635907295e-15" cy="96"></circle><circle class="handle" r="6" cx="-14.832815729997472" cy="45.650712782167375"></circle><circle class="handle" r="6" cx="-28.213692110038707" cy="38.83281572999748"></circle><circle class="handle" r="6" cx="-38.83281572999747" cy="28.213692110038714"></circle><circle class="handle" r="6" cx="-45.65071278216737" cy="14.832815729997481"></circle><circle class="handle" r="6" cx="-144" cy="1.7634913907721887e-14"></circle><circle class="handle" r="6" cx="-45.65071278216737" cy="-14.832815729997492"></circle><circle class="handle" r="6" cx="-38.832815729997485" cy="-28.213692110038707"></circle><circle class="handle" r="6" cx="-28.213692110038714" cy="-38.83281572999747"></circle><circle class="handle" r="6" cx="-44.49844718999245" cy="-136.9521383465021"></circle><circle class="handle" r="6" cx="-3.5269827815443773e-14" cy="-192"></circle><circle class="handle" r="6" cx="29.665631459994934" cy="-91.30142556433475"></circle><circle class="handle" r="6" cx="56.4273842200774" cy="-77.66563145999497"></circle><circle class="handle" r="6" cx="77.66563145999494" cy="-56.42738422007744"></circle><circle class="handle" r="6" cx="45.65071278216737" cy="-14.832815729997488"></circle></g></g></svg>
        <label for="log">Log:</label>
        <textarea id="log" placeholder="Log..."></textarea>
        <div class="sleep-row">
            <label for="hours-slept">Sleep (h):</label>
            <input type="number" id="hours-slept" step="0.5" min="0" max="24" placeholder="7.5">
            <span id="last-entry-date"></span>
        </div>

        <div class="controls">
            <button id="randomize">Randomize petals</button>
            <button id="save">Save + Download DB + Page</button>
            <button id="copyJson">Copy JSON</button>
            <button id="clear">Clear DB</button>
        </div>

        <div id="status">30-day average (33 entries)</div>
    </div>

    <div id="right">
        <h2>Scores Over Time</h2>
        <div class="legend">
            <span style="display:inline-block;width:80px;height:12px;border-radius:2px;background:linear-gradient(to right, #7832a0, #a0a0a0, #ffdc28);vertical-align:middle"></span>
            <span style="font-size:11px">Neg ← Color → Pos</span> &nbsp;|&nbsp; Height = Balance, Saturation = Intensity
        </div>
        <svg id="timeseries" viewBox="0,0,760,310">
            
        <g transform="translate(70,10)"><g transform="translate(0,250)" fill="none" font-size="10" font-family="sans-serif" text-anchor="middle"><path class="domain" stroke="currentColor" d="M0.5,6V0.5H670.5V6"></path><g class="tick" opacity="1" transform="translate(47.401705116878226,0)"><line stroke="currentColor" y2="6"></line><text fill="currentColor" y="9" dy="0.71em">September</text></g><g class="tick" opacity="1" transform="translate(163.85274829885682,0)"><line stroke="currentColor" y2="6"></line><text fill="currentColor" y="9" dy="0.71em">October</text></g><g class="tick" opacity="1" transform="translate(284.3472304802097,0)"><line stroke="currentColor" y2="6"></line><text fill="currentColor" y="9" dy="0.71em">November</text></g><g class="tick" opacity="1" transform="translate(400.79827366218836,0)"><line stroke="currentColor" y2="6"></line><text fill="currentColor" y="9" dy="0.71em">December</text></g><g class="tick" opacity="1" transform="translate(521.1310182835662,0)"><line stroke="currentColor" y2="6"></line><text fill="currentColor" y="9" dy="0.71em">2026</text></g><g class="tick" opacity="1" transform="translate(641.4637629049441,0)"><line stroke="currentColor" y2="6"></line><text fill="currentColor" y="9" dy="0.71em">February</text></g></g><g fill="none" font-size="10" font-family="sans-serif" text-anchor="end"><path class="domain" stroke="currentColor" d="M-6,250.5H0.5V0.5H-6"></path><g class="tick" opacity="1" transform="translate(0,250.5)"><line stroke="currentColor" x2="-6"></line><text fill="currentColor" x="-9" dy="0.32em">−40</text></g><g class="tick" opacity="1" transform="translate(0,219.25)"><line stroke="currentColor" x2="-6"></line><text fill="currentColor" x="-9" dy="0.32em">−30</text></g><g class="tick" opacity="1" transform="translate(0,188)"><line stroke="currentColor" x2="-6"></line><text fill="currentColor" x="-9" dy="0.32em">−20</text></g><g class="tick" opacity="1" transform="translate(0,156.75)"><line stroke="currentColor" x2="-6"></line><text fill="currentColor" x="-9" dy="0.32em">−10</text></g><g class="tick" opacity="1" transform="translate(0,125.5)"><line stroke="currentColor" x2="-6"></line><text fill="currentColor" x="-9" dy="0.32em">0</text></g><g class="tick" opacity="1" transform="translate(0,94.25)"><line stroke="currentColor" x2="-6"></line><text fill="currentColor" x="-9" dy="0.32em">10</text></g><g class="tick" opacity="1" transform="translate(0,63)"><line stroke="currentColor" x2="-6"></line><text fill="currentColor" x="-9" dy="0.32em">20</text></g><g class="tick" opacity="1" transform="translate(0,31.75)"><line stroke="currentColor" x2="-6"></line><text fill="currentColor" x="-9" dy="0.32em">30</text></g><g class="tick" opacity="1" transform="translate(0,0.5)"><line stroke="currentColor" x2="-6"></line><text fill="currentColor" x="-9" dy="0.32em">40</text></g></g><line x1="0" x2="670" y1="125" y2="125" stroke="#999" stroke-dasharray="4,4" opacity="0.7"></line><rect class="bar" x="-3.0855263157894735" y="96.87499999999999" width="6.171052631578947" height="28.125000000000014" fill="rgb(204, 163, 89)" opacity="0.7"></rect><rect class="bar" x="-1.162780723188928" y="112.49999999999999" width="6.171052631578947" height="12.500000000000014" fill="rgb(186, 153, 113)" opacity="0.7"></rect><rect class="bar" x="12.682089865875007" y="125" width="6.171052631578947" height="6.25" fill="rgb(171, 144, 133)" opacity="0.7"></rect><rect class="bar" x="12.868741928859524" y="125" width="6.171052631578947" height="0" fill="rgb(176, 146, 126)" opacity="0.7"></rect><rect class="bar" x="14.207188571771493" y="125" width="6.171052631578947" height="34.375" fill="rgb(158, 116, 137)" opacity="0.7"></rect><rect class="bar" x="25.941934090574378" y="87.5" width="6.171052631578947" height="37.5" fill="rgb(207, 171, 90)" opacity="0.7"></rect><rect class="bar" x="59.38580228640717" y="103.125" width="6.171052631578947" height="21.875" fill="rgb(203, 155, 86)" opacity="0.7"></rect><rect class="bar" x="66.79349539013599" y="115.625" width="6.171052631578947" height="9.375" fill="rgb(191, 146, 102)" opacity="0.7"></rect><rect class="bar" x="70.6989478554363" y="115.625" width="6.171052631578947" height="9.375" fill="rgb(191, 146, 102)" opacity="0.7"></rect><rect class="bar" x="134.50964091627068" y="106.25000000000001" width="6.171052631578947" height="18.749999999999986" fill="rgb(194, 155, 101)" opacity="0.7"></rect><rect class="bar" x="142.22643201868067" y="125" width="6.171052631578947" height="12.5" fill="rgb(161, 156, 156)" opacity="0.7"></rect><rect class="bar" x="153.881320560715" y="93.75" width="6.171052631578947" height="31.25" fill="rgb(192, 168, 111)" opacity="0.7"></rect><rect class="bar" x="229.83295834981098" y="84.375" width="6.171052631578947" height="40.625" fill="rgb(180, 171, 134)" opacity="0.7"></rect><rect class="bar" x="230.01696106170894" y="84.375" width="6.171052631578947" height="40.625" fill="rgb(180, 171, 134)" opacity="0.7"></rect><rect class="bar" x="232.6188291905144" y="93.75" width="6.171052631578947" height="31.25" fill="rgb(190, 168, 116)" opacity="0.7"></rect><rect class="bar" x="232.63936896208918" y="100" width="6.171052631578947" height="25" fill="rgb(192, 163, 110)" opacity="0.7"></rect><rect class="bar" x="243.1392821304437" y="71.875" width="6.171052631578947" height="53.125" fill="rgb(210, 185, 92)" opacity="0.7"></rect><rect class="bar" x="260.80231910771164" y="125" width="6.171052631578947" height="3.125" fill="rgb(168, 149, 140)" opacity="0.7"></rect><rect class="bar" x="262.55802610195485" y="125" width="6.171052631578947" height="12.5" fill="rgb(165, 144, 142)" opacity="0.7"></rect><rect class="bar" x="270.7802800108509" y="71.875" width="6.171052631578947" height="53.125" fill="rgb(200, 183, 107)" opacity="0.7"></rect><rect class="bar" x="375.3120929841999" y="125" width="6.171052631578947" height="31.25" fill="rgb(157, 130, 147)" opacity="0.7"></rect><rect class="bar" x="379.188470517323" y="118.75" width="6.171052631578947" height="6.25" fill="rgb(177, 152, 127)" opacity="0.7"></rect><rect class="bar" x="398.6709945724328" y="125" width="6.171052631578947" height="9.375" fill="rgb(160, 160, 160)" opacity="0.7"></rect><rect class="bar" x="398.7448980794728" y="125" width="6.171052631578947" height="9.375" fill="rgb(160, 160, 160)" opacity="0.7"></rect><rect class="bar" x="398.7781380233821" y="125" width="6.171052631578947" height="9.375" fill="rgb(160, 160, 160)" opacity="0.7"></rect><rect class="bar" x="398.78337746671036" y="125" width="6.171052631578947" height="9.375" fill="rgb(160, 160, 160)" opacity="0.7"></rect><rect class="bar" x="398.8025681673266" y="125" width="6.171052631578947" height="9.375" fill="rgb(160, 160, 160)" opacity="0.7"></rect><rect class="bar" x="398.81330695725666" y="125" width="6.171052631578947" height="9.375" fill="rgb(160, 160, 160)" opacity="0.7"></rect><rect class="bar" x="404.86966073311555" y="125" width="6.171052631578947" height="9.375" fill="rgb(173, 135, 123)" opacity="0.7"></rect><rect class="bar" x="404.954753379336" y="125" width="6.171052631578947" height="3.125" fill="rgb(182, 135, 109)" opacity="0.7"></rect><rect class="bar" x="410.6769421259998" y="93.75" width="6.171052631578947" height="31.25" fill="rgb(210, 164, 81)" opacity="0.7"></rect><rect class="bar" x="424.3008606532456" y="96.87499999999999" width="6.171052631578947" height="28.125000000000014" fill="rgb(206, 162, 86)" opacity="0.7"></rect><rect class="bar" x="424.30606060565304" y="96.87499999999999" width="6.171052631578947" height="28.125000000000014" fill="rgb(206, 162, 86)" opacity="0.7"></rect><rect class="bar" x="432.2451796623184" y="118.75" width="6.171052631578947" height="6.25" fill="rgb(187, 144, 105)" opacity="0.7"></rect><rect class="bar" x="432.26298216047195" y="118.75" width="6.171052631578947" height="6.25" fill="rgb(187, 144, 105)" opacity="0.7"></rect><rect class="bar" x="432.2772095397164" y="118.75" width="6.171052631578947" height="6.25" fill="rgb(187, 144, 105)" opacity="0.7"></rect><rect class="bar" x="432.28083677406147" y="106.25000000000001" width="6.171052631578947" height="18.749999999999986" fill="rgb(194, 155, 101)" opacity="0.7"></rect><rect class="bar" x="432.3037378690848" y="106.25000000000001" width="6.171052631578947" height="18.749999999999986" fill="rgb(194, 155, 101)" opacity="0.7"></rect><rect class="bar" x="447.13588076166235" y="125" width="6.171052631578947" height="0" fill="rgb(182, 140, 112)" opacity="0.7"></rect><rect class="bar" x="450.20223319485217" y="96.87499999999999" width="6.171052631578947" height="28.125000000000014" fill="rgb(206, 162, 86)" opacity="0.7"></rect><rect class="bar" x="455.5101061123182" y="112.49999999999999" width="6.171052631578947" height="12.500000000000014" fill="rgb(192, 149, 101)" opacity="0.7"></rect><rect class="bar" x="460.8476402156894" y="112.49999999999999" width="6.171052631578947" height="12.500000000000014" fill="rgb(192, 149, 101)" opacity="0.7"></rect><rect class="bar" x="491.0242890707643" y="106.25000000000001" width="6.171052631578947" height="18.749999999999986" fill="rgb(194, 155, 101)" opacity="0.7"></rect><rect class="bar" x="571.739387241793" y="81.24999999999999" width="6.171052631578947" height="43.750000000000014" fill="rgb(217, 176, 78)" opacity="0.7"></rect><rect class="bar" x="587.5499038619698" y="125" width="6.171052631578947" height="3.125" fill="rgb(181, 137, 112)" opacity="0.7"></rect><rect class="bar" x="587.5692626348671" y="125" width="6.171052631578947" height="3.125" fill="rgb(181, 137, 112)" opacity="0.7"></rect><rect class="bar" x="592.7834145217778" y="125" width="6.171052631578947" height="46.875" fill="rgb(149, 105, 144)" opacity="0.7"></rect><rect class="bar" x="592.7857176197048" y="125" width="6.171052631578947" height="46.875" fill="rgb(149, 105, 144)" opacity="0.7"></rect><rect class="bar" x="594.774967001341" y="125" width="6.171052631578947" height="46.875" fill="rgb(149, 105, 144)" opacity="0.7"></rect><rect class="bar" x="594.7831630521927" y="125" width="6.171052631578947" height="75" fill="rgb(129, 67, 155)" opacity="0.7"></rect><rect class="bar" x="594.7893485254656" y="125" width="6.171052631578947" height="75" fill="rgb(129, 67, 155)" opacity="0.7"></rect><rect class="bar" x="594.8551417025607" y="125" width="6.171052631578947" height="43.75" fill="rgb(153, 100, 135)" opacity="0.7"></rect><rect class="bar" x="594.9130105029777" y="125" width="6.171052631578947" height="25" fill="rgb(167, 117, 124)" opacity="0.7"></rect><rect class="bar" x="594.9275800470158" y="125" width="6.171052631578947" height="25" fill="rgb(167, 117, 124)" opacity="0.7"></rect><rect class="bar" x="598.5068497708309" y="121.87500000000001" width="6.171052631578947" height="3.124999999999986" fill="rgb(181, 144, 116)" opacity="0.7"></rect><rect class="bar" x="608.2866833311053" y="115.625" width="6.171052631578947" height="9.375" fill="rgb(189, 148, 105)" opacity="0.7"></rect><rect class="bar" x="613.5527066549279" y="125" width="6.171052631578947" height="43.75" fill="rgb(153, 104, 139)" opacity="0.7"></rect><rect class="bar" x="613.9970916080987" y="125" width="6.171052631578947" height="43.75" fill="rgb(153, 104, 139)" opacity="0.7"></rect><rect class="bar" x="618.2134312489102" y="125" width="6.171052631578947" height="46.875" fill="rgb(149, 111, 149)" opacity="0.7"></rect><rect class="bar" x="618.2525498589265" y="125" width="6.171052631578947" height="46.875" fill="rgb(149, 111, 149)" opacity="0.7"></rect><rect class="bar" x="619.9880932562031" y="125" width="6.171052631578947" height="53.125" fill="rgb(145, 113, 156)" opacity="0.7"></rect><rect class="bar" x="619.9897343083845" y="125" width="6.171052631578947" height="53.125" fill="rgb(145, 113, 156)" opacity="0.7"></rect><rect class="bar" x="620.0081292152786" y="125" width="6.171052631578947" height="53.125" fill="rgb(145, 113, 156)" opacity="0.7"></rect><rect class="bar" x="623.8028213285176" y="125" width="6.171052631578947" height="65.625" fill="rgb(136, 95, 160)" opacity="0.7"></rect><rect class="bar" x="623.8226242956525" y="125" width="6.171052631578947" height="62.5" fill="rgb(138, 96, 157)" opacity="0.7"></rect><rect class="bar" x="623.9032497953935" y="125" width="6.171052631578947" height="50" fill="rgb(148, 100, 145)" opacity="0.7"></rect><rect class="bar" x="627.7099333110374" y="125" width="6.171052631578947" height="50" fill="rgb(148, 100, 145)" opacity="0.7"></rect><rect class="bar" x="627.7262851131322" y="125" width="6.171052631578947" height="56.25" fill="rgb(145, 86, 142)" opacity="0.7"></rect><rect class="bar" x="633.8733757717108" y="125" width="6.171052631578947" height="9.375" fill="rgb(172, 137, 126)" opacity="0.7"></rect><rect class="bar" x="633.8774428872919" y="125" width="6.171052631578947" height="9.375" fill="rgb(172, 137, 126)" opacity="0.7"></rect><rect class="bar" x="636.6287277681703" y="103.125" width="6.171052631578947" height="21.875" fill="rgb(197, 158, 97)" opacity="0.7"></rect><rect class="bar" x="641.380855019567" y="115.625" width="6.171052631578947" height="9.375" fill="rgb(187, 149, 109)" opacity="0.7"></rect><rect class="bar" x="641.420428246908" y="115.625" width="6.171052631578947" height="9.375" fill="rgb(187, 149, 109)" opacity="0.7"></rect><rect class="bar" x="641.5316545379234" y="118.75" width="6.171052631578947" height="6.25" fill="rgb(184, 147, 112)" opacity="0.7"></rect><rect class="bar" x="651.2375892635763" y="125" width="6.171052631578947" height="6.25" fill="rgb(175, 138, 123)" opacity="0.7"></rect><rect class="bar" x="666.9144736842105" y="125" width="6.171052631578947" height="21.875" fill="rgb(161, 140, 147)" opacity="0.7"></rect><path fill="none" stroke="#333" stroke-width="1.5" d="M0,96.875L1.923,112.5L15.768,131.25L15.954,125L17.293,159.375L29.027,87.5L62.471,103.125L69.879,115.625L73.784,115.625L137.595,106.25L145.312,137.5L156.967,93.75L232.918,84.375L233.102,84.375L235.704,93.75L235.725,100L246.225,71.875L263.888,128.125L265.644,137.5L273.866,71.875L378.398,156.25L382.274,118.75L401.757,134.375L401.83,134.375L401.864,134.375L401.869,134.375L401.888,134.375L401.899,134.375L407.955,134.375L408.04,128.125L413.762,93.75L427.386,96.875L427.392,96.875L435.331,118.75L435.349,118.75L435.363,118.75L435.366,106.25L435.389,106.25L450.221,125L453.288,96.875L458.596,112.5L463.933,112.5L494.11,106.25L574.825,81.25L590.635,128.125L590.655,128.125L595.869,171.875L595.871,171.875L597.86,171.875L597.869,200L597.875,200L597.941,168.75L597.999,150L598.013,150L601.592,121.875L611.372,115.625L616.638,168.75L617.083,168.75L621.299,171.875L621.338,171.875L623.074,178.125L623.075,178.125L623.094,178.125L626.888,190.625L626.908,187.5L626.989,175L630.795,175L630.812,181.25L636.959,134.375L636.963,134.375L639.714,103.125L644.466,115.625L644.506,115.625L644.617,118.75L654.323,131.25L670,146.875"></path><circle class="pt" cx="0" cy="96.87499999999999" r="5" fill="rgb(204, 163, 89)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="1.9227455926005455" cy="112.49999999999999" r="5" fill="rgb(186, 153, 113)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="15.767616181664481" cy="131.25" r="5" fill="rgb(171, 144, 133)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="15.954268244648997" cy="125" r="5" fill="rgb(176, 146, 126)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="17.292714887560965" cy="159.375" r="5" fill="rgb(158, 116, 137)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="29.02746040636385" cy="87.5" r="5" fill="rgb(207, 171, 90)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="62.47132860219664" cy="103.125" r="5" fill="rgb(203, 155, 86)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="69.87902170592547" cy="115.625" r="5" fill="rgb(191, 146, 102)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="73.78447417122578" cy="115.625" r="5" fill="rgb(191, 146, 102)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="137.59516723206016" cy="106.25000000000001" r="5" fill="rgb(194, 155, 101)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="145.31195833447015" cy="137.5" r="5" fill="rgb(161, 156, 156)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="156.9668468765045" cy="93.75" r="5" fill="rgb(192, 168, 111)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="232.91848466560046" cy="84.375" r="5" fill="rgb(180, 171, 134)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="233.10248737749842" cy="84.375" r="5" fill="rgb(180, 171, 134)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="235.70435550630387" cy="93.75" r="5" fill="rgb(190, 168, 116)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="235.72489527787866" cy="100" r="5" fill="rgb(192, 163, 110)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="246.22480844623317" cy="71.875" r="5" fill="rgb(210, 185, 92)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="263.8878454235011" cy="128.125" r="5" fill="rgb(168, 149, 140)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="265.64355241774433" cy="137.5" r="5" fill="rgb(165, 144, 142)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="273.8658063266404" cy="71.875" r="5" fill="rgb(200, 183, 107)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="378.3976192999894" cy="156.25" r="5" fill="rgb(157, 130, 147)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="382.2739968331125" cy="118.75" r="5" fill="rgb(177, 152, 127)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="401.75652088822227" cy="134.375" r="5" fill="rgb(160, 160, 160)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="401.8304243952623" cy="134.375" r="5" fill="rgb(160, 160, 160)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="401.8636643391716" cy="134.375" r="5" fill="rgb(160, 160, 160)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="401.86890378249984" cy="134.375" r="5" fill="rgb(160, 160, 160)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="401.8880944831161" cy="134.375" r="5" fill="rgb(160, 160, 160)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="401.89883327304614" cy="134.375" r="5" fill="rgb(160, 160, 160)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="407.95518704890503" cy="134.375" r="5" fill="rgb(173, 135, 123)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="408.0402796951255" cy="128.125" r="5" fill="rgb(182, 135, 109)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="413.7624684417893" cy="93.75" r="5" fill="rgb(210, 164, 81)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="427.3863869690351" cy="96.87499999999999" r="5" fill="rgb(206, 162, 86)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="427.3915869214425" cy="96.87499999999999" r="5" fill="rgb(206, 162, 86)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="435.33070597810786" cy="118.75" r="5" fill="rgb(187, 144, 105)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="435.34850847626143" cy="118.75" r="5" fill="rgb(187, 144, 105)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="435.3627358555059" cy="118.75" r="5" fill="rgb(187, 144, 105)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="435.36636308985095" cy="106.25000000000001" r="5" fill="rgb(194, 155, 101)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="435.38926418487426" cy="106.25000000000001" r="5" fill="rgb(194, 155, 101)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="450.22140707745183" cy="125" r="5" fill="rgb(182, 140, 112)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="453.28775951064165" cy="96.87499999999999" r="5" fill="rgb(206, 162, 86)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="458.5956324281077" cy="112.49999999999999" r="5" fill="rgb(192, 149, 101)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="463.9331665314789" cy="112.49999999999999" r="5" fill="rgb(192, 149, 101)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="494.1098153865538" cy="106.25000000000001" r="5" fill="rgb(194, 155, 101)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="574.8249135575825" cy="81.24999999999999" r="5" fill="rgb(217, 176, 78)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="590.6354301777593" cy="128.125" r="5" fill="rgb(181, 137, 112)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="590.6547889506566" cy="128.125" r="5" fill="rgb(181, 137, 112)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="595.8689408375673" cy="171.875" r="5" fill="rgb(149, 105, 144)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="595.8712439354942" cy="171.875" r="5" fill="rgb(149, 105, 144)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="597.8604933171305" cy="171.875" r="5" fill="rgb(149, 105, 144)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="597.8686893679821" cy="200" r="5" fill="rgb(129, 67, 155)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="597.8748748412551" cy="200" r="5" fill="rgb(129, 67, 155)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="597.9406680183502" cy="168.75" r="5" fill="rgb(153, 100, 135)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="597.9985368187672" cy="150" r="5" fill="rgb(167, 117, 124)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="598.0131063628053" cy="150" r="5" fill="rgb(167, 117, 124)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="601.5923760866203" cy="121.87500000000001" r="5" fill="rgb(181, 144, 116)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="611.3722096468948" cy="115.625" r="5" fill="rgb(189, 148, 105)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="616.6382329707174" cy="168.75" r="5" fill="rgb(153, 104, 139)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="617.0826179238882" cy="168.75" r="5" fill="rgb(153, 104, 139)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="621.2989575646997" cy="171.875" r="5" fill="rgb(149, 111, 149)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="621.338076174716" cy="171.875" r="5" fill="rgb(149, 111, 149)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="623.0736195719926" cy="178.125" r="5" fill="rgb(145, 113, 156)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="623.075260624174" cy="178.125" r="5" fill="rgb(145, 113, 156)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="623.0936555310681" cy="178.125" r="5" fill="rgb(145, 113, 156)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="626.888347644307" cy="190.625" r="5" fill="rgb(136, 95, 160)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="626.908150611442" cy="187.5" r="5" fill="rgb(138, 96, 157)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="626.988776111183" cy="175" r="5" fill="rgb(148, 100, 145)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="630.7954596268269" cy="175" r="5" fill="rgb(148, 100, 145)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="630.8118114289217" cy="181.25" r="5" fill="rgb(145, 86, 142)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="636.9589020875003" cy="134.375" r="5" fill="rgb(172, 137, 126)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="636.9629692030813" cy="134.375" r="5" fill="rgb(172, 137, 126)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="639.7142540839598" cy="103.125" r="5" fill="rgb(197, 158, 97)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="644.4663813353565" cy="115.625" r="5" fill="rgb(187, 149, 109)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="644.5059545626975" cy="115.625" r="5" fill="rgb(187, 149, 109)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="644.6171808537129" cy="118.75" r="5" fill="rgb(184, 147, 112)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="654.3231155793658" cy="131.25" r="5" fill="rgb(175, 138, 123)" stroke="#333" stroke-width="1"></circle><circle class="pt" cx="670" cy="146.875" r="5" fill="rgb(161, 140, 147)" stroke="#333" stroke-width="1"></circle><text x="335" y="288" text-anchor="middle">Date</text><text x="-125" y="-48" text-anchor="middle" transform="rotate(-90)">Balance (−40 to +40)</text></g></svg>

        <div id="intent-anchor"></div>

    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
    <script>
        (async function () {
            // --- PANAS items
            const ITEMS = ["Interested", "Distressed", "Excited", "Upset", "Strong", "Guilty", "Scared", "Hostile", "Enthusiastic", "Proud", "Irritable", "Alert", "Ashamed", "Inspired", "Nervous", "Determined", "Attentive", "Jittery", "Active", "Afraid"];
            const POS_IDX = [1, 3, 5, 9, 10, 12, 14, 16, 17, 19];
            const NEG_IDX = [2, 4, 6, 7, 8, 11, 13, 15, 18, 20];
            // Create sets for quick lookup (convert to 0-based)
            const POS_ITEMS = new Set(POS_IDX.map(i => ITEMS[i - 1]));
            const NEG_ITEMS = new Set(NEG_IDX.map(i => ITEMS[i - 1]));



            // --- SQLite init
            const SQL = await initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/${f}` });
            const LSKEY = "panas_db";
            const SETTINGS_KEY = "panas_gh_settings";
            function base64ToU8(b64) { if (!b64) return new Uint8Array(); const s = atob(b64); const u = new Uint8Array(s.length); for (let i = 0; i < s.length; i++)u[i] = s.charCodeAt(i); return u; }
            function u8ToBase64(u8) { let s = ""; u8.forEach(b => s += String.fromCharCode(b)); return btoa(s); }
            function persist() { localStorage.setItem(LSKEY, u8ToBase64(db.export())); }

            // GitHub Sync Functions
            function getGHSettings() {
                const saved = localStorage.getItem(SETTINGS_KEY);
                return saved ? JSON.parse(saved) : { token: "", owner: "rlhjansen", repo: "minimal_mood_dashboard", branch: "main", path: "data/entries.json" };
            }

            function saveGHSettings(settings) {
                localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            }

            function setSyncStatus(msg, isError = false) {
                const el = document.getElementById("syncStatus");
                if (el) {
                    el.textContent = msg;
                    el.style.color = isError ? "#d62728" : "#2ca02c";
                }
            }

            async function syncFromGitHub() {
                const settings = getGHSettings();
                if (!settings.token || !settings.owner || !settings.repo) {
                    console.log("GitHub sync not configured, skipping pull.");
                    return false;
                }

                try {
                    const url = `https://api.github.com/repos/${settings.owner}/${settings.repo}/contents/${settings.path}?ref=${settings.branch}`;
                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `token ${settings.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (response.status === 404) {
                        console.log("No remote data file found yet, will create on first push.");
                        return false;
                    }

                    if (!response.ok) {
                        throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();
                    const content = atob(data.content.replace(/\s/g, ''));
                    const entries = JSON.parse(content);

                    if (!Array.isArray(entries) || entries.length === 0) {
                        console.log("No entries in remote file.");
                        return false;
                    }

                    // Merge remote entries into local DB
                    const existingIds = new Set();
                    const res = db.exec("SELECT id FROM entries");
                    if (res.length > 0) {
                        res[0].values.forEach(row => existingIds.add(row[0]));
                    }

                    let importedCount = 0;
                    entries.forEach(entry => {
                        if (!existingIds.has(entry.id)) {
                            const cols = ["id", "ts", "log", ...ITEMS, "positive_score", "negative_score"];
                            const vals = [entry.id, entry.ts, entry.log || "", ...ITEMS.map(k => entry.items[k]), entry.positive_score, entry.negative_score];
                            const q = `INSERT INTO entries (${cols.map(c => '"' + c + '"').join(",")}) VALUES (${cols.map(() => "?").join(",")})`;
                            const stmt = db.prepare(q);
                            stmt.run(vals);
                            stmt.free();
                            importedCount++;
                        }
                    });

                    if (importedCount > 0) {
                        persist();
                        console.log(`Synced ${importedCount} new entries from GitHub.`);
                        setSyncStatus(`Synced ${importedCount} new entries from GitHub.`);
                        return true;
                    } else {
                        console.log("Already up to date with GitHub.");
                        return false;
                    }
                } catch (error) {
                    console.error("Sync from GitHub failed:", error);
                    setSyncStatus(`Sync failed: ${error.message}`, true);
                    return false;
                }
            }

            async function syncToGitHub() {
                const settings = getGHSettings();
                if (!settings.token || !settings.owner || !settings.repo) {
                    console.log("GitHub sync not configured, skipping push.");
                    return;
                }

                try {
                    // First, pull any remote changes to avoid conflicts
                    await syncFromGitHub();

                    const entries = getAllEntries();
                    const content = JSON.stringify(entries, null, 2);
                    const encodedContent = btoa(unescape(encodeURIComponent(content)));

                    // Get current file SHA (fresh after pull)
                    const url = `https://api.github.com/repos/${settings.owner}/${settings.repo}/contents/${settings.path}?ref=${settings.branch}`;
                    let sha = null;

                    const getResponse = await fetch(url, {
                        headers: {
                            'Authorization': `token ${settings.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });

                    if (getResponse.ok) {
                        const fileData = await getResponse.json();
                        sha = fileData.sha;
                    }

                    // Create or update file
                    const putResponse = await fetch(url.split('?')[0], {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${settings.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Update mood entries (${entries.length} total)`,
                            content: encodedContent,
                            branch: settings.branch,
                            ...(sha && { sha })
                        })
                    });

                    if (!putResponse.ok) {
                        throw new Error(`GitHub API error: ${putResponse.status} ${putResponse.statusText}`);
                    }

                    console.log(`Pushed ${entries.length} entries to GitHub.`);
                    setSyncStatus(`Pushed ${entries.length} entries to GitHub.`);
                } catch (error) {
                    console.error("Sync to GitHub failed:", error);
                    setSyncStatus(`Push failed: ${error.message}`, true);
                }
            }

            let dbBytes = base64ToU8(localStorage.getItem(LSKEY) || "");
            let db = dbBytes.length ? new SQL.Database(dbBytes) : new SQL.Database();

            // base schema
            db.exec(`CREATE TABLE IF NOT EXISTS entries (id INTEGER PRIMARY KEY AUTOINCREMENT, ts TEXT)`);
            const ensureCol = (name, type) => {
                const info = db.exec(`PRAGMA table_info(entries)`)[0]?.values || [];
                const names = info.map(r => r[1]);
                if (!names.includes(name)) { db.exec(`ALTER TABLE entries ADD COLUMN "${name}" ${type}`); }
            };
            ensureCol("log", "TEXT");
            ITEMS.forEach(it => ensureCol(it, "INTEGER NOT NULL DEFAULT 3"));
            ensureCol("positive_score", "INTEGER");
            ensureCol("negative_score", "INTEGER");
            ensureCol("hours_slept", "REAL");
            db.exec(`UPDATE entries SET log='' WHERE log IS NULL`);
            persist();

            // Load GitHub settings into UI
            const ghSettings = getGHSettings();
            document.getElementById("ghToken").value = ghSettings.token || "";
            document.getElementById("ghOwner").value = ghSettings.owner || "rlhjansen";
            document.getElementById("ghRepo").value = ghSettings.repo || "minimal_mood_dashboard";
            document.getElementById("ghBranch").value = ghSettings.branch || "main";
            document.getElementById("ghPath").value = ghSettings.path || "data/entries.json";

            // Toggle settings visibility
            document.getElementById("toggleSettings").onclick = () => {
                const box = document.getElementById("settingsBox");
                box.classList.toggle("expanded");
            };

            // Auto-sync from GitHub on page load
            (async () => {
                const synced = await syncFromGitHub();
                if (synced) {
                    refreshFromDb();
                }
            })();

            // Save settings
            document.getElementById("saveSettings").onclick = () => {
                const settings = {
                    token: document.getElementById("ghToken").value.trim(),
                    owner: document.getElementById("ghOwner").value.trim(),
                    repo: document.getElementById("ghRepo").value.trim(),
                    branch: document.getElementById("ghBranch").value.trim(),
                    path: document.getElementById("ghPath").value.trim()
                };
                saveGHSettings(settings);
                setSyncStatus("Settings saved!");
            };

            // Test sync button
            document.getElementById("testSync").onclick = async () => {
                setSyncStatus("Syncing...");
                const synced = await syncFromGitHub();
                if (synced) {
                    refreshFromDb();
                }
                await syncToGitHub();
            };

            // --- Import (.sqlite)
            const importBox = document.getElementById("importBox");
            const fileInput = document.getElementById("fileInput");
            const status = t => document.getElementById("status").textContent = t;
            const setHover = on => importBox.classList.toggle("hover", !!on);

            ["dragenter", "dragover"].forEach(ev => {
                importBox.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); setHover(true); });
            });
            ["dragleave", "dragend", "drop"].forEach(ev => {
                importBox.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); if (ev !== "drop") setHover(false); });
            });
            importBox.addEventListener("click", () => fileInput.click());
            importBox.addEventListener("keydown", (e) => { if (e.key === "Enter" || e.key === " ") { e.preventDefault(); fileInput.click(); } });

            importBox.addEventListener("drop", (e) => {
                setHover(false);
                const f = e.dataTransfer.files?.[0];
                if (f) importDbFromFile(f);
            });
            fileInput.addEventListener("change", () => {
                const f = fileInput.files?.[0];
                if (f) importDbFromFile(f);
                fileInput.value = "";
            });

            async function importDbFromFile(file) {
                try {
                    status(`Importing "${file.name}"...`);
                    const buf = await file.arrayBuffer();
                    const u8 = new Uint8Array(buf);
                    const tmp = new SQL.Database(u8);
                    const needCols = () => {
                        const info = tmp.exec(`PRAGMA table_info(entries)`)[0]?.values || [];
                        const names = new Set(info.map(r => r[1]));
                        if (!names.has("log")) tmp.exec(`ALTER TABLE entries ADD COLUMN "log" TEXT`);
                        ITEMS.forEach(it => { if (!names.has(it)) tmp.exec(`ALTER TABLE entries ADD COLUMN "${it}" INTEGER NOT NULL DEFAULT 3`); });
                        if (!names.has("positive_score")) tmp.exec(`ALTER TABLE entries ADD COLUMN "positive_score" INTEGER`);
                        if (!names.has("negative_score")) tmp.exec(`ALTER TABLE entries ADD COLUMN "negative_score" INTEGER`);
                    };
                    needCols();
                    db = tmp;
                    persist();
                    refreshFromDb();
                    status(`Imported ${file.name} and refreshed from latest entry.`);
                } catch (err) {
                    console.error(err);
                    status("Import failed: not a valid PANAS SQLite file?");
                    alert("Import failed. Ensure you're selecting the exported panas.sqlite file.");
                }
            }

            // Helpers to read latest entry and refresh UI
            function getMostRecentEntry() {
                const res = db.exec(`SELECT ${ITEMS.map(n => `"${n}"`).join(",")} FROM entries ORDER BY id DESC LIMIT 1`);
                if (!res.length) return null;
                const row = res[0].values[0];
                const o = {}; ITEMS.forEach((n, i) => o[n] = row[i]);
                return o;
            }

            // --- Windrose setup
            const size = 620, radius = size / 2 - 70, levels = 5;
            // Clear any existing content from saved HTML
            d3.select("#radar").selectAll("*").remove();
            const svg = d3.select("#radar").attr("viewBox", [0, 0, size, size]).append("g").attr("transform", `translate(${size / 2},${size / 2})`);
            let labels = d3.shuffle(ITEMS.slice());
            let values = {};

            const last = getMostRecentEntry();
            ITEMS.forEach(l => values[l] = last ? (last[l] ?? 3) : 3);

            const step = radius / levels;
            const angleForIndex = i => (i / labels.length) * 2 * Math.PI;
            const posOnSpoke = (angle, v) => [Math.cos(angle) * (v * step), Math.sin(angle) * (v * step)];

            for (let l = 1; l <= levels; l++) { svg.append("circle").attr("r", l * step).attr("class", "grid"); }

            // Wedge background group (inserted before axes so axes draw on top)
            const wedgeGroup = svg.append("g").attr("class", "wedges");

            // Helper to create arc path for a wedge
            function wedgePath(startAngle, endAngle, innerRadius, outerRadius) {
                const arc = d3.arc()
                    .innerRadius(innerRadius)
                    .outerRadius(outerRadius)
                    .startAngle(startAngle)
                    .endAngle(endAngle);
                return arc();
            }

            // Get wedge color based on item type (pos/neg) and value
            function getWedgeColor(label, value) {
                const isPositive = POS_ITEMS.has(label);
                // Saturation: value 1→5 maps to 0→1
                const sat = (value - 1) / 4;
                const baseColor = isPositive ? d3.rgb(255, 220, 40) : d3.rgb(120, 50, 160); // bright yellow / deep purple
                const gray = d3.rgb(240, 240, 240); // light gray base
                return d3.interpolateRgb(gray, baseColor)(sat);
            }

            function drawWedges() {
                wedgeGroup.selectAll("path").remove();
                const n = labels.length;
                const wedgeAngle = (2 * Math.PI) / n;
                labels.forEach((label, i) => {
                    const startAngle = angleForIndex(i) - wedgeAngle / 2 + Math.PI / 2;
                    const endAngle = startAngle + wedgeAngle;
                    const val = values[label];
                    wedgeGroup.append("path")
                        .attr("d", wedgePath(startAngle, endAngle, 0, radius))
                        .attr("fill", getWedgeColor(label, val));
                });
            }

            function drawAxes() {
                svg.selectAll(".axis").remove();
                svg.selectAll(".label").remove();
                labels.forEach((label, i) => {
                    const a = angleForIndex(i);
                    svg.append("line").attr("class", "axis").attr("x1", 0).attr("y1", 0).attr("x2", Math.cos(a) * radius).attr("y2", Math.sin(a) * radius);
                    svg.append("text").attr("class", "label").attr("x", Math.cos(a) * (radius + 20)).attr("y", Math.sin(a) * (radius + 20)).text(label);
                });
            }
            drawAxes();

            const refPoly = svg.append("path").attr("class", "reference");
            const curPoly = svg.append("path").attr("class", "current");
            const previewPoly = svg.append("path").attr("class", "preview");
            const monthlyPoly = svg.append("path").attr("class", "monthly");
            const handleGroup = svg.append("g");

            function updateHandlePositions() {
                handleGroup.selectAll("circle")
                    .attr("cx", d => posOnSpoke(d.angle, values[d.label])[0])
                    .attr("cy", d => posOnSpoke(d.angle, values[d.label])[1]);
            }

            let handles = handleGroup.selectAll("circle")
                .data(labels.map((label, i) => ({ label, angle: angleForIndex(i) })))
                .join("circle")
                .attr("class", "handle")
                .attr("r", 6)
                .attr("cx", d => posOnSpoke(d.angle, values[d.label])[0])
                .attr("cy", d => posOnSpoke(d.angle, values[d.label])[1])
                .call(d3.drag().on("drag", function (ev, d) {
                    const r = Math.min(radius, Math.hypot(ev.x, ev.y));
                    let val = Math.round(r / step);
                    val = Math.max(1, Math.min(5, val));
                    values[d.label] = val;
                    d3.select(this).attr("cx", posOnSpoke(d.angle, val)[0]).attr("cy", posOnSpoke(d.angle, val)[1]);
                    drawPolygons();
                    drawMonthlyAverage(); // keep monthly visible while editing
                }));

            function polygonForVals(valMap) { return labels.map((lbl, i) => posOnSpoke(angleForIndex(i), valMap[lbl])); }

            function drawPolygons() {
                drawWedges(); // Update wedge background colors
                const ptsCur = polygonForVals(values);
                curPoly.attr("d", d3.line().curve(d3.curveLinearClosed)(ptsCur));
                const ref = getMostRecentEntry();
                if (ref) {
                    const ptsRef = polygonForVals(ref);
                    refPoly.attr("d", d3.line().curve(d3.curveLinearClosed)(ptsRef));
                } else { refPoly.attr("d", null); }
            }

            function drawPreview(valMapOrNull) {
                if (!valMapOrNull) { previewPoly.attr("d", null); return; }
                const pts = polygonForVals(valMapOrNull);
                previewPoly.attr("d", d3.line().curve(d3.curveLinearClosed)(pts));
            }

            function computeMonthlyAverage() {
                const sinceISO = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();
                const q = `SELECT ${ITEMS.map(n => `"${n}"`).join(",")} FROM entries WHERE ts>='${sinceISO}'`;
                const res = db.exec(q);
                if (!res.length) return null;
                const rows = res[0].values;
                const sums = Object.fromEntries(ITEMS.map(n => [n, 0]));
                rows.forEach(r => { ITEMS.forEach((n, i) => { sums[n] += (r[i] ?? 3); }); });
                const cnt = rows.length;
                const avg = {}; ITEMS.forEach(n => avg[n] = sums[n] / cnt);
                return { avg, count: cnt };
            }

            function drawMonthlyAverage() {
                const m = computeMonthlyAverage();
                if (!m) { monthlyPoly.attr("d", null); status("No entries in last 30 days."); return; }
                const pts = polygonForVals(m.avg);
                monthlyPoly.attr("d", d3.line().curve(d3.curveLinearClosed)(pts));
                status(`30-day average (${m.count} ${m.count === 1 ? "entry" : "entries"})`);
            }

            // Initial draw
            drawPolygons();
            drawMonthlyAverage();

            // Randomize layout (keep values)
            document.getElementById("randomize").onclick = () => {
                labels = d3.shuffle(labels.slice());
                handles = handleGroup.selectAll("circle")
                    .data(labels.map((label, i) => ({ label, angle: angleForIndex(i) })))
                    .join("circle")
                    .attr("class", "handle")
                    .attr("r", 6)
                    .attr("cx", d => posOnSpoke(d.angle, values[d.label])[0])
                    .attr("cy", d => posOnSpoke(d.angle, values[d.label])[1])
                    .call(d3.drag().on("drag", function (ev, d) {
                        const r = Math.min(radius, Math.hypot(ev.x, ev.y));
                        let val = Math.round(r / step);
                        val = Math.max(1, Math.min(5, val));
                        values[d.label] = val;
                        d3.select(this).attr("cx", posOnSpoke(d.angle, val)[0]).attr("cy", posOnSpoke(d.angle, val)[1]);
                        drawPolygons();
                        drawMonthlyAverage();
                    }));
                drawAxes();
                drawPolygons();
                drawPreview(null);
                drawMonthlyAverage();
                status("Petals randomized (values preserved).");
            };

            // Save
            document.getElementById("save").onclick = async () => {
                const missing = ITEMS.filter(k => !(values[k] >= 1 && values[k] <= 5));
                if (missing.length) { status("Please rate all 20 items (1–5)."); return; }

                const ts = new Date().toISOString();
                const log = document.getElementById("log").value.trim();
                const sleepEl = document.getElementById("hours-slept");
                const hourSlept = sleepEl.value ? parseFloat(sleepEl.value) : null;
                const getByIndex = i1 => values[ITEMS[i1 - 1]];
                const posScore = POS_IDX.reduce((s, i) => s + getByIndex(i), 0);
                const negScore = NEG_IDX.reduce((s, i) => s + getByIndex(i), 0);

                const cols = ["ts", "log", ...ITEMS, "positive_score", "negative_score", "hours_slept"];
                const q = `INSERT INTO entries (${cols.map(c => '"' + c + '"').join(",")}) VALUES (${cols.map(() => "?").join(",")})`;
                const vals = [ts, log, ...ITEMS.map(k => values[k]), posScore, negScore, hourSlept];
                const stmt = db.prepare(q); stmt.run(vals); stmt.free(); persist();

                const latest = getMostRecentEntry();
                ITEMS.forEach(k => values[k] = (latest && latest[k] != null) ? latest[k] : 3);
                updateHandlePositions();
                drawPolygons();
                drawPreview(null);
                drawTimeSeries();
                drawMonthlyAverage();

                downloadDBAndPage();
                status("Saved & downloaded database + page.");
                document.getElementById("log").value = "";
                document.getElementById("hours-slept").value = "";
                updateLastEntryDate();

                // Auto-sync to GitHub after save
                await syncToGitHub();
            };

            // Clear
            document.getElementById("clear").onclick = () => {
                if (!confirm("Delete all saved entries?")) return;
                db.exec("DELETE FROM entries"); persist();
                ITEMS.forEach(k => values[k] = 3);
                updateHandlePositions();
                drawPolygons(); drawPreview(null); drawTimeSeries();
                monthlyPoly.attr("d", null);
                status("Database cleared.");
            };

            // ===== Copy JSON =====
            function getAllEntries() {
                const res = db.exec(`SELECT id, ts, log, positive_score, negative_score, ${ITEMS.map(n => `"${n}"`).join(",")} FROM entries ORDER BY ts ASC`);
                if (!res.length) return [];
                const rows = res[0].values;
                return rows.map(r => {
                    const obj = { id: r[0], ts: r[1], log: r[2] || "", positive_score: r[3], negative_score: r[4], items: {} };
                    ITEMS.forEach((name, idx) => obj.items[name] = r[5 + idx]);
                    return obj;
                });
            }

            async function copyJSON() {
                const data = getAllEntries();
                const text = JSON.stringify(data, null, 2);
                if (!data.length) { status("No entries to copy."); return; }
                try {
                    await navigator.clipboard.writeText(text);
                    status(`Copied ${data.length} ${data.length === 1 ? "entry" : "entries"} to clipboard as JSON.`);
                } catch (e) {
                    // Fallback: try execCommand, then download
                    try {
                        const ta = document.createElement("textarea");
                        ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta);
                        status(`Copied ${data.length} ${data.length === 1 ? "entry" : "entries"} to clipboard as JSON.`);
                    } catch (err) {
                        const blob = new Blob([text], { type: "application/json" });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a"); a.href = url; a.download = "panas.json"; a.click(); URL.revokeObjectURL(url);
                        status("Clipboard blocked. Downloaded panas.json instead.");
                    }
                }
            }

            document.getElementById("copyJson").onclick = copyJSON;

            // Timeseries
            const tsvg = d3.select("#timeseries").attr("viewBox", [0, 0, 760, 310]);
            const tooltip = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 0);

            function drawTimeSeries() {
                tsvg.selectAll("*").remove();
                const res = db.exec(`SELECT ts, positive_score, negative_score, log, ${ITEMS.map(n => `"${n}"`).join(",")} FROM entries ORDER BY ts ASC`);
                if (!res.length) return;
                const rows = res[0].values.map(r => {
                    const itemVals = {}; ITEMS.forEach((name, idx) => itemVals[name] = r[4 + idx]);
                    const pos = r[1], neg = r[2];
                    const total = pos + neg; // total intensity (20-100 range, since each is 10-50)
                    // Log ratio: log(pos/neg), symmetric around 0 when equal
                    // Range is roughly -1.6 to +1.6 (log(10/50) to log(50/10))
                    const logRatio = Math.log(pos / neg);
                    return { ts: new Date(r[0]), pos, neg, diff: pos - neg, total, logRatio, log: r[3] || "", itemVals };
                });

                // Calculate saturation scale based on YOUR actual score range
                // Full 0→1 saturation range mapped to your data's min→max
                const totalMin = d3.min(rows, d => d.total);
                const totalMax = d3.max(rows, d => d.total);
                const satScale = d3.scaleLinear().domain([totalMin, totalMax]).range([0, 1]).clamp(true);

                // Map log ratio to 0-1 for color interpolation
                // Use YOUR actual data range so the most extreme entry gets full color
                const absLogRatioMax = d3.max(rows, d => Math.abs(d.logRatio));
                const logRatioScale = d3.scaleLinear().domain([-absLogRatioMax, absLogRatioMax]).range([0, 1]).clamp(true);

                // Color function: log ratio determines color (yellow for positive, purple for negative)
                // We interpolate in RGB space
                function getColor(d) {
                    // logRatio: negative = more negative affect, 0 = equal, positive = more positive affect
                    const sat = satScale(d.total);
                    // Purple for negative, yellow for positive
                    const purple = d3.rgb(120, 50, 160);  // deep purple
                    const yellow = d3.rgb(255, 220, 40);  // bright yellow

                    // Map log ratio to 0-1 range for interpolation
                    const colorT = logRatioScale(d.logRatio);
                    const baseColor = d3.interpolateRgb(purple, yellow)(colorT);

                    // Apply saturation: interpolate between gray and the base color
                    const gray = d3.rgb(160, 160, 160);
                    return d3.interpolateRgb(gray, baseColor)(sat);
                }

                const margin = { l: 70, r: 20, t: 10, b: 50 };
                const W = 760, H = 310, iw = W - margin.l - margin.r, ih = H - margin.t - margin.b;
                const g = tsvg.append("g").attr("transform", `translate(${margin.l},${margin.t})`);
                const x = d3.scaleTime().domain(d3.extent(rows, d => d.ts)).range([0, iw]);
                const y = d3.scaleLinear().domain([-40, 40]).range([ih, 0]); // centered for difference

                g.append("g").attr("transform", `translate(0,${ih})`).call(d3.axisBottom(x));
                g.append("g").call(d3.axisLeft(y));

                // Add zero line for reference
                const y0 = y(0);
                g.append("line").attr("x1", 0).attr("x2", iw).attr("y1", y0).attr("y2", y0)
                    .attr("stroke", "#999").attr("stroke-dasharray", "4,4").attr("opacity", 0.7);

                // Draw filled bars from zero to each point
                const barWidth = Math.max(2, Math.min(20, iw / rows.length * 0.7));
                g.selectAll(".bar").data(rows).enter().append("rect").attr("class", "bar")
                    .attr("x", d => x(d.ts) - barWidth / 2)
                    .attr("y", d => d.diff >= 0 ? y(d.diff) : y0)
                    .attr("width", barWidth)
                    .attr("height", d => Math.abs(y(d.diff) - y0))
                    .attr("fill", d => getColor(d))
                    .attr("opacity", 0.7);

                // Draw line connecting points
                const lineDiff = d3.line().x(d => x(d.ts)).y(d => y(d.diff));
                g.append("path").datum(rows).attr("fill", "none").attr("stroke", "#333").attr("stroke-width", 1.5).attr("d", lineDiff);

                const showTip = (ev, d) => {
                    tooltip.style("opacity", 1)
                        .html(`<b>${d.ts.toLocaleString()}</b><br>Balance: ${d.diff} (Pos: ${d.pos}, Neg: ${d.neg})<br>Log ratio: ${d.logRatio.toFixed(2)}${d.log ? `<div style="margin-top:4px;opacity:.9">${d.log.replace(/</g, "&lt;")}</div>` : ""}`)
                        .style("left", (ev.pageX + 10) + "px").style("top", (ev.pageY - 28) + "px");
                };
                const hideTip = () => tooltip.style("opacity", 0);

                function onOver(ev, d) {
                    showTip(ev, d);
                    drawMonthlyAverage();    // ensure monthly is drawn once (for status), then hide
                    monthlyPoly.attr("d", null);
                    drawPreview(d.itemVals);
                    status(`Previewing ${d.ts.toLocaleString()} on windrose`);
                }
                function onMove(ev, d) { showTip(ev, d); }
                function onOut() {
                    hideTip();
                    drawPreview(null);
                    drawMonthlyAverage();    // restore monthly average on idle
                }

                // Interactive circles on top
                g.selectAll(".pt").data(rows).enter().append("circle").attr("class", "pt")
                    .attr("cx", d => x(d.ts)).attr("cy", d => y(d.diff)).attr("r", 5)
                    .attr("fill", d => getColor(d)).attr("stroke", "#333").attr("stroke-width", 1)
                    .on("mouseover", onOver).on("mousemove", onMove).on("mouseout", onOut);

                g.append("text").attr("x", iw / 2).attr("y", ih + 38).attr("text-anchor", "middle").text("Date");
                g.append("text").attr("x", -ih / 2).attr("y", -48).attr("text-anchor", "middle").attr("transform", "rotate(-90)").text("Balance (−40 to +40)");
            }
            drawTimeSeries();

            function refreshFromDb() {
                const latest = getMostRecentEntry();
                ITEMS.forEach(k => values[k] = (latest && latest[k] != null) ? latest[k] : 3);
                updateHandlePositions();
                drawPolygons();
                drawPreview(null);
                drawTimeSeries();
                drawMonthlyAverage();
            }

            function downloadDBAndPage() {
                const dbBlob = new Blob([db.export()], { type: "application/x-sqlite3" });
                const dbUrl = URL.createObjectURL(dbBlob);
                const adb = document.createElement("a");
                adb.href = dbUrl; adb.download = "panas.sqlite"; adb.click();
                URL.revokeObjectURL(dbUrl);
                const html = document.documentElement.outerHTML;
                const pageBlob = new Blob([html], { type: "text/html" });
                const pageUrl = URL.createObjectURL(pageBlob);
                const ap = document.createElement("a");
                ap.href = pageUrl; ap.download = "panas.html"; ap.click();
                URL.revokeObjectURL(pageUrl);
            }

            // Initial alignment
            updateHandlePositions();
            drawPolygons();

            // Show whether last PANAS entry is from today
            function updateLastEntryDate() {
                const el = document.getElementById('last-entry-date');
                if (!el) return;
                const res = db.exec('SELECT ts FROM entries ORDER BY id DESC LIMIT 1');
                if (!res.length || !res[0].values.length) { el.innerHTML = '<span class="stale">No entries yet</span>'; return; }
                const lastTs = new Date(res[0].values[0][0]);
                const today = new Date();
                const isToday = lastTs.toDateString() === today.toDateString();
                const label = lastTs.toLocaleDateString() + ' ' + lastTs.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
                el.innerHTML = isToday
                    ? '<span class="fresh">✓ Last entry: ' + label + '</span>'
                    : '<span class="stale">⚠ Last entry: ' + label + '</span>';
            }
            updateLastEntryDate();

            // Expose shared state for external modules (js/intent.js etc.)
            window.panasDB = db;
            window.panasPersist = persist;
            window.panasGetSleep = function() {
                var el = document.getElementById('hours-slept');
                return el && el.value ? parseFloat(el.value) : null;
            };
            window.dispatchEvent(new CustomEvent('panas-db-ready'));
        })();
    </script>
    <script src="js/intent.js"></script>


    <div class="tooltip" style="opacity: 0;"></div>


    <div class="tooltip" style="opacity: 0;"></div>


<div class="tooltip" style="opacity: 0;"></div></body></html>